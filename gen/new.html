<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>new</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:image" content="thumbnail.gif" />
</head>
<body>
<script src="lib.js"></script>
<script>
    let prog
    function newArt() {
        prog = program(recreateCanvas(), `

uniform float time;

${glslVignetteFunction()}
${glslNoise2dFunction()}
${glslGetColorFunction()}

mat2 rot(float a) {
    float cs = cos(a);
    float sn = sin(a);
    return mat2(cs,sn,-sn,cs);
}

float rand(float n){return fract(sin(n) * 43758.5453123);}

float noise(float p){
    float fl = floor(p), fc = fract(p);
    return mix(rand(fl), rand(fl + 1.0), fc);
}

float superformula(float phi, float m, float n1, float n2, float n3, float a, float b){
    vec2 r = vec2(m) * phi / 4.;
    r = vec2(cos(r.x), sin(r.y));
    r = pow(abs(r/vec2(a, b)), vec2(n2, n3));
    return pow(r.x + r.y, -1. / n1);
}

float map(in vec3 p) {

    float m = 18.*noise(p.y);
    float n1 = 1.17;
    float n2 = sin(p.y)*noise(cos(time))*3.;
    float n3 = 1.87*noise(p.y+31.)+noise(sin(p.y));
    float a = sin(p.y)*noise(cos(time*.3))*3.;
    float b = 1.3;
    float phi = atan(p.z, p.x);

    float v = length(p.xz) - superformula(phi, m, n1, n2, n3, a, b);
    return v;//smoothstep(-0.1,.0, v)*0.5 - smoothstep(0.,.1, v)*0.5;
}




vec3 trip(vec2 uv) {
    vec2 p = uv;

    float vp = 2.;

    vec3 ro = vec3(-vp, time*4.0, 0.);
    vec3 rd = normalize(vec3(uv.y-vp, resolution.y, uv.x));

    float f;
    for( float i=0.0; i<99.0; i++ ) {
        f = .99 * f;
        vec3 p = ro + i*rd*0.1;
        float c = map(p);
        // float l = length(p);
        f += c*0.01 ;
        // gl_FragColor.rgb += vec3(
        //     pow(c, 1.01 + sin(l-time)),
        //     c,
        //     pow(c, 1.01 + cos(time+l))
        // ) * 0.1;

    }




        vec3 color1 =  getColor(f) ;
        vec3 color2 =  getColor(f+1.) ;
        vec3 color3 =  getColor(f+2.) ;

        float v = fract(uv.y*${2+rnd(14)}) + noise2d(p*${rnd(400)+200}) ;
        float v1 = length(p) ;
        vec3 col =  mix(color1, color2, clamp(0.,1.,v));
        col = mix(col, color3, clamp(0.,1.,v1));
        return vec3(f);
}

void main() {
    vec2 uv = gl_FragCoord.xy/resolution - 0.5;
    uv.x *= resolution.x/resolution.y;
    vec3 color = trip(uv);
    // color += trip(uv + vec2(-0.2, -0.2)/resolution);
    // color += trip(uv + vec2(+0.2, -0.2)/resolution);
    // color += trip(uv + vec2(-0.2, +0.2)/resolution);
    // color += trip(uv + vec2(+0.2, +0.2)/resolution);
    // color /= 4.;
    // color *= vignette(${0.2 + rnd(0.2)});
    gl_FragColor = vec4(color, 1.0);
}

        `);
        prog.uf1('time', rnd(11111))
        prog.draw();
    }


    // requestAnimationFrame(function animate(t){
    //     prog &&prog.uf1('time', t/1000)
    //     prog &&prog.draw();
    //     requestAnimationFrame(animate)
    // })


    addEventListener('pointerdown', e => (!e || e.button === 0) && newArt());
    addEventListener('resize', e => prog.draw());
    newArt();
</script>
</body>
</html>