<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inner Sight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:image" content="thumbnail.gif" />
</head>
<body>
<script src="100.js"></script>
<script src="lib.js"></script>
<script>
    let prog
    function newArt() {
        prog = program(recreateCanvas(), `

const float time = ${rnd(1111)};

${glslNoise2dFunction()}
${glslGetColorFunction()}

vec2 mirror(vec2 uv){
     const float count = ${rndInt(7)}. + 3.;
     float a = 3.1415/count/2.;
     float cs = cos(a), sn = sin(a);
     mat2 rot = mat2(cs, -sn, sn, cs);
     for (float i = 0.0; i<count; i++ )
         uv = abs(uv*rot);
     return uv;
}

float shape(vec2 uv, float y){
    y = sin(y*0.1)*0.4+0.6;
    for(float i=1.; i<${3+rndInt(17)}.; i++) {
        uv = mirror(uv);
        uv -= i*${0.1+rnd(0.3)}*y;
    }
    uv *= 32.*y;
    vec2 index = floor(uv);
    uv = fract(uv);
    return smoothstep(0.15, 0.1, abs(fract(uv.x+time*0.2)-0.51));
}

float map(in vec3 p) {

    return shape(p.xz, p.y);
}

void main() {
    vec2 uv = gl_FragCoord.xy - resolution.xy*.5;
    vec3 ro;
    // if (${rnd(1)>0.7}) ro.x += ${rnd(0.5)-0.25};
    if (${rnd(1)>0.5}) ro.y += ${rnd(8)-4};
    if (${rnd(1)>0.1}) ro.x += ${rnd(1)-0.5};
	vec3 rd = normalize(vec3(uv.y, resolution.y, uv.x));

    for( float i=0.0; i<16.0; i++ ) {
        gl_FragColor = .95 * gl_FragColor;
        vec3 p = ro + i*rd*0.05;
        float c = map(p);
        float l = length(p*14.);
        gl_FragColor.rgb += c * getColor(i+length(p*15.)) * 0.2;
    }

    gl_FragColor = vec4( clamp( gl_FragColor.rgb, 0.0, 1.0 ), 1. );
}
        `);

        prog &&prog.draw()
    }
    let time = 0, playing = false, t0 = 0;

    requestAnimationFrame(function animate(t){
        let dt = t - t0;
        t0 = t;
        if (playing)
            time += dt/1000;
        prog &&prog.uf1('dx', time)
        prog &&prog.uf1('dy', time)
        prog &&prog.draw();
        // requestAnimationFrame(animate)
    })


    addEventListener('pointerdown', ev => (!ev || ev.button === 0) && newArt());
    addEventListener('resize', ev => prog.draw());
    // addEventListener('keyup', ev => {
    //     playing = !playing;
    // })
    newArt();
</script>
</body>
</html>