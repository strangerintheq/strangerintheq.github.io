(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();window.cfg={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:81.200.147.103:3478"},{urls:"turn:global.relay.metered.ca:80",username:"f6507426c0f4f89d0bda02e2",credential:"7YF0907XexAfvkbL"},{urls:"turn:global.relay.metered.ca:443",username:"f6507426c0f4f89d0bda02e2",credential:"7YF0907XexAfvkbL"},{urls:"turn:81.200.147.103:3478",username:"chessclubturn",credential:"vhSsAm602ITECZv1"}]};var ne,g,St,F,Je,kt,Tt,Et,Ue,Ce,Pe,Ct,ee={},Pt=[],pn=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,se=Array.isArray;function U(t,e){for(var n in e)t[n]=e[n];return t}function Ae(t){t&&t.parentNode&&t.parentNode.removeChild(t)}function M(t,e,n){var s,r,i,o={};for(i in e)i=="key"?s=e[i]:i=="ref"?r=e[i]:o[i]=e[i];if(arguments.length>2&&(o.children=arguments.length>3?ne.call(arguments,2):n),typeof t=="function"&&t.defaultProps!=null)for(i in t.defaultProps)o[i]===void 0&&(o[i]=t.defaultProps[i]);return Z(t,o,s,r,null)}function Z(t,e,n,s,r){var i={type:t,props:e,key:n,ref:s,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:r??++St,__i:-1,__u:0};return r==null&&g.vnode!=null&&g.vnode(i),i}function mn(){return{current:null}}function $(t){return t.children}function A(t,e){this.props=t,this.context=e}function J(t,e){if(e==null)return t.__?J(t.__,t.__i+1):null;for(var n;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null)return n.__e;return typeof t.type=="function"?J(t):null}function Rt(t){var e,n;if((t=t.__)!=null&&t.__c!=null){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if((n=t.__k[e])!=null&&n.__e!=null){t.__e=t.__c.base=n.__e;break}return Rt(t)}}function Re(t){(!t.__d&&(t.__d=!0)&&F.push(t)&&!fe.__r++||Je!=g.debounceRendering)&&((Je=g.debounceRendering)||kt)(fe)}function fe(){for(var t,e,n,s,r,i,o,c=1;F.length;)F.length>c&&F.sort(Tt),t=F.shift(),c=F.length,t.__d&&(n=void 0,s=void 0,r=(s=(e=t).__v).__e,i=[],o=[],e.__P&&((n=U({},s)).__v=s.__v+1,g.vnode&&g.vnode(n),Ne(e.__P,n,s,e.__n,e.__P.namespaceURI,32&s.__u?[r]:null,i,r??J(s),!!(32&s.__u),o),n.__v=s.__v,n.__.__k[n.__i]=n,xt(i,n,o),s.__e=s.__=null,n.__e!=r&&Rt(n)));fe.__r=0}function Ot(t,e,n,s,r,i,o,c,u,l,f){var a,m,h,_,d,p,b,v=s&&s.__k||Pt,x=e.length;for(u=bn(n,e,v,u,x),a=0;a<x;a++)(h=n.__k[a])!=null&&(m=h.__i==-1?ee:v[h.__i]||ee,h.__i=a,p=Ne(t,h,m,r,i,o,c,u,l,f),_=h.__e,h.ref&&m.ref!=h.ref&&(m.ref&&je(m.ref,null,h),f.push(h.ref,h.__c||_,h)),d==null&&_!=null&&(d=_),(b=!!(4&h.__u))||m.__k===h.__k?u=It(h,u,t,b):typeof h.type=="function"&&p!==void 0?u=p:_&&(u=_.nextSibling),h.__u&=-7);return n.__e=d,u}function bn(t,e,n,s,r){var i,o,c,u,l,f=n.length,a=f,m=0;for(t.__k=new Array(r),i=0;i<r;i++)(o=e[i])!=null&&typeof o!="boolean"&&typeof o!="function"?(u=i+m,(o=t.__k[i]=typeof o=="string"||typeof o=="number"||typeof o=="bigint"||o.constructor==String?Z(null,o,null,null,null):se(o)?Z($,{children:o},null,null,null):o.constructor==null&&o.__b>0?Z(o.type,o.props,o.key,o.ref?o.ref:null,o.__v):o).__=t,o.__b=t.__b+1,c=null,(l=o.__i=gn(o,n,u,a))!=-1&&(a--,(c=n[l])&&(c.__u|=2)),c==null||c.__v==null?(l==-1&&(r>f?m--:r<f&&m++),typeof o.type!="function"&&(o.__u|=4)):l!=u&&(l==u-1?m--:l==u+1?m++:(l>u?m--:m++,o.__u|=4))):t.__k[i]=null;if(a)for(i=0;i<f;i++)(c=n[i])!=null&&(2&c.__u)==0&&(c.__e==s&&(s=J(c)),Lt(c,c));return s}function It(t,e,n,s){var r,i;if(typeof t.type=="function"){for(r=t.__k,i=0;r&&i<r.length;i++)r[i]&&(r[i].__=t,e=It(r[i],e,n,s));return e}t.__e!=e&&(s&&(e&&t.type&&!e.parentNode&&(e=J(t)),n.insertBefore(t.__e,e||null)),e=t.__e);do e=e&&e.nextSibling;while(e!=null&&e.nodeType==8);return e}function j(t,e){return e=e||[],t==null||typeof t=="boolean"||(se(t)?t.some(function(n){j(n,e)}):e.push(t)),e}function gn(t,e,n,s){var r,i,o,c=t.key,u=t.type,l=e[n],f=l!=null&&(2&l.__u)==0;if(l===null&&t.key==null||f&&c==l.key&&u==l.type)return n;if(s>(f?1:0)){for(r=n-1,i=n+1;r>=0||i<e.length;)if((l=e[o=r>=0?r--:i++])!=null&&(2&l.__u)==0&&c==l.key&&u==l.type)return o}return-1}function Ve(t,e,n){e[0]=="-"?t.setProperty(e,n??""):t[e]=n==null?"":typeof n!="number"||pn.test(e)?n:n+"px"}function ce(t,e,n,s,r){var i,o;e:if(e=="style")if(typeof n=="string")t.style.cssText=n;else{if(typeof s=="string"&&(t.style.cssText=s=""),s)for(e in s)n&&e in n||Ve(t.style,e,"");if(n)for(e in n)s&&n[e]==s[e]||Ve(t.style,e,n[e])}else if(e[0]=="o"&&e[1]=="n")i=e!=(e=e.replace(Et,"$1")),o=e.toLowerCase(),e=o in t||e=="onFocusOut"||e=="onFocusIn"?o.slice(2):e.slice(2),t.l||(t.l={}),t.l[e+i]=n,n?s?n.u=s.u:(n.u=Ue,t.addEventListener(e,i?Pe:Ce,i)):t.removeEventListener(e,i?Pe:Ce,i);else{if(r=="http://www.w3.org/2000/svg")e=e.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(e!="width"&&e!="height"&&e!="href"&&e!="list"&&e!="form"&&e!="tabIndex"&&e!="download"&&e!="rowSpan"&&e!="colSpan"&&e!="role"&&e!="popover"&&e in t)try{t[e]=n??"";break e}catch{}typeof n=="function"||(n==null||n===!1&&e[4]!="-"?t.removeAttribute(e):t.setAttribute(e,e=="popover"&&n==1?"":n))}}function Ge(t){return function(e){if(this.l){var n=this.l[e.type+t];if(e.t==null)e.t=Ue++;else if(e.t<n.u)return;return n(g.event?g.event(e):e)}}}function Ne(t,e,n,s,r,i,o,c,u,l){var f,a,m,h,_,d,p,b,v,x,C,ie,Q,Be,oe,X,Se,L=e.type;if(e.constructor!=null)return null;128&n.__u&&(u=!!(32&n.__u),i=[c=e.__e=n.__e]),(f=g.__b)&&f(e);e:if(typeof L=="function")try{if(b=e.props,v="prototype"in L&&L.prototype.render,x=(f=L.contextType)&&s[f.__c],C=f?x?x.props.value:f.__:s,n.__c?p=(a=e.__c=n.__c).__=a.__E:(v?e.__c=a=new L(b,C):(e.__c=a=new A(b,C),a.constructor=L,a.render=yn),x&&x.sub(a),a.props=b,a.state||(a.state={}),a.context=C,a.__n=s,m=a.__d=!0,a.__h=[],a._sb=[]),v&&a.__s==null&&(a.__s=a.state),v&&L.getDerivedStateFromProps!=null&&(a.__s==a.state&&(a.__s=U({},a.__s)),U(a.__s,L.getDerivedStateFromProps(b,a.__s))),h=a.props,_=a.state,a.__v=e,m)v&&L.getDerivedStateFromProps==null&&a.componentWillMount!=null&&a.componentWillMount(),v&&a.componentDidMount!=null&&a.__h.push(a.componentDidMount);else{if(v&&L.getDerivedStateFromProps==null&&b!==h&&a.componentWillReceiveProps!=null&&a.componentWillReceiveProps(b,C),!a.__e&&a.shouldComponentUpdate!=null&&a.shouldComponentUpdate(b,a.__s,C)===!1||e.__v==n.__v){for(e.__v!=n.__v&&(a.props=b,a.state=a.__s,a.__d=!1),e.__e=n.__e,e.__k=n.__k,e.__k.some(function(q){q&&(q.__=e)}),ie=0;ie<a._sb.length;ie++)a.__h.push(a._sb[ie]);a._sb=[],a.__h.length&&o.push(a);break e}a.componentWillUpdate!=null&&a.componentWillUpdate(b,a.__s,C),v&&a.componentDidUpdate!=null&&a.__h.push(function(){a.componentDidUpdate(h,_,d)})}if(a.context=C,a.props=b,a.__P=t,a.__e=!1,Q=g.__r,Be=0,v){for(a.state=a.__s,a.__d=!1,Q&&Q(e),f=a.render(a.props,a.state,a.context),oe=0;oe<a._sb.length;oe++)a.__h.push(a._sb[oe]);a._sb=[]}else do a.__d=!1,Q&&Q(e),f=a.render(a.props,a.state,a.context),a.state=a.__s;while(a.__d&&++Be<25);a.state=a.__s,a.getChildContext!=null&&(s=U(U({},s),a.getChildContext())),v&&!m&&a.getSnapshotBeforeUpdate!=null&&(d=a.getSnapshotBeforeUpdate(h,_)),X=f,f!=null&&f.type===$&&f.key==null&&(X=Dt(f.props.children)),c=Ot(t,se(X)?X:[X],e,n,s,r,i,o,c,u,l),a.base=e.__e,e.__u&=-161,a.__h.length&&o.push(a),p&&(a.__E=a.__=null)}catch(q){if(e.__v=null,u||i!=null)if(q.then){for(e.__u|=u?160:128;c&&c.nodeType==8&&c.nextSibling;)c=c.nextSibling;i[i.indexOf(c)]=null,e.__e=c}else{for(Se=i.length;Se--;)Ae(i[Se]);Oe(e)}else e.__e=n.__e,e.__k=n.__k,q.then||Oe(e);g.__e(q,e,n)}else i==null&&e.__v==n.__v?(e.__k=n.__k,e.__e=n.__e):c=e.__e=vn(n.__e,e,n,s,r,i,o,u,l);return(f=g.diffed)&&f(e),128&e.__u?void 0:c}function Oe(t){t&&t.__c&&(t.__c.__e=!0),t&&t.__k&&t.__k.forEach(Oe)}function xt(t,e,n){for(var s=0;s<n.length;s++)je(n[s],n[++s],n[++s]);g.__c&&g.__c(e,t),t.some(function(r){try{t=r.__h,r.__h=[],t.some(function(i){i.call(r)})}catch(i){g.__e(i,r.__v)}})}function Dt(t){return typeof t!="object"||t==null||t.__b&&t.__b>0?t:se(t)?t.map(Dt):U({},t)}function vn(t,e,n,s,r,i,o,c,u){var l,f,a,m,h,_,d,p=n.props,b=e.props,v=e.type;if(v=="svg"?r="http://www.w3.org/2000/svg":v=="math"?r="http://www.w3.org/1998/Math/MathML":r||(r="http://www.w3.org/1999/xhtml"),i!=null){for(l=0;l<i.length;l++)if((h=i[l])&&"setAttribute"in h==!!v&&(v?h.localName==v:h.nodeType==3)){t=h,i[l]=null;break}}if(t==null){if(v==null)return document.createTextNode(b);t=document.createElementNS(r,v,b.is&&b),c&&(g.__m&&g.__m(e,i),c=!1),i=null}if(v==null)p===b||c&&t.data==b||(t.data=b);else{if(i=i&&ne.call(t.childNodes),p=n.props||ee,!c&&i!=null)for(p={},l=0;l<t.attributes.length;l++)p[(h=t.attributes[l]).name]=h.value;for(l in p)if(h=p[l],l!="children"){if(l=="dangerouslySetInnerHTML")a=h;else if(!(l in b)){if(l=="value"&&"defaultValue"in b||l=="checked"&&"defaultChecked"in b)continue;ce(t,l,null,h,r)}}for(l in b)h=b[l],l=="children"?m=h:l=="dangerouslySetInnerHTML"?f=h:l=="value"?_=h:l=="checked"?d=h:c&&typeof h!="function"||p[l]===h||ce(t,l,h,p[l],r);if(f)c||a&&(f.__html==a.__html||f.__html==t.innerHTML)||(t.innerHTML=f.__html),e.__k=[];else if(a&&(t.innerHTML=""),Ot(e.type=="template"?t.content:t,se(m)?m:[m],e,n,s,v=="foreignObject"?"http://www.w3.org/1999/xhtml":r,i,o,i?i[0]:n.__k&&J(n,0),c,u),i!=null)for(l=i.length;l--;)Ae(i[l]);c||(l="value",v=="progress"&&_==null?t.removeAttribute("value"):_!=null&&(_!==t[l]||v=="progress"&&!_||v=="option"&&_!=p[l])&&ce(t,l,_,p[l],r),l="checked",d!=null&&d!=t[l]&&ce(t,l,d,p[l],r))}return t}function je(t,e,n){try{if(typeof t=="function"){var s=typeof t.__u=="function";s&&t.__u(),s&&e==null||(t.__u=t(e))}else t.current=e}catch(r){g.__e(r,n)}}function Lt(t,e,n){var s,r;if(g.unmount&&g.unmount(t),(s=t.ref)&&(s.current&&s.current!=t.__e||je(s,null,e)),(s=t.__c)!=null){if(s.componentWillUnmount)try{s.componentWillUnmount()}catch(i){g.__e(i,e)}s.base=s.__P=null}if(s=t.__k)for(r=0;r<s.length;r++)s[r]&&Lt(s[r],e,n||typeof t.type!="function");n||Ae(t.__e),t.__c=t.__=t.__e=void 0}function yn(t,e,n){return this.constructor(t,n)}function te(t,e,n){var s,r,i,o;e==document&&(e=document.documentElement),g.__&&g.__(t,e),r=(s=typeof n=="function")?null:n&&n.__k||e.__k,i=[],o=[],Ne(e,t=(!s&&n||e).__k=M($,null,[t]),r||ee,ee,e.namespaceURI,!s&&n?[n]:r?null:e.firstChild?ne.call(e.childNodes):null,i,!s&&n?n:r?r.__e:e.firstChild,s,o),xt(i,t,o)}function Ut(t,e){te(t,e,Ut)}function wn(t,e,n){var s,r,i,o,c=U({},t.props);for(i in t.type&&t.type.defaultProps&&(o=t.type.defaultProps),e)i=="key"?s=e[i]:i=="ref"?r=e[i]:c[i]=e[i]===void 0&&o!=null?o[i]:e[i];return arguments.length>2&&(c.children=arguments.length>3?ne.call(arguments,2):n),Z(t.type,c,s||t.key,r||t.ref,null)}function Sn(t){function e(n){var s,r;return this.getChildContext||(s=new Set,(r={})[e.__c]=this,this.getChildContext=function(){return r},this.componentWillUnmount=function(){s=null},this.shouldComponentUpdate=function(i){this.props.value!=i.value&&s.forEach(function(o){o.__e=!0,Re(o)})},this.sub=function(i){s.add(i);var o=i.componentWillUnmount;i.componentWillUnmount=function(){s&&s.delete(i),o&&o.call(i)}}),n.children}return e.__c="__cC"+Ct++,e.__=t,e.Provider=e.__l=(e.Consumer=function(n,s){return n.children(s)}).contextType=e,e}ne=Pt.slice,g={__e:function(t,e,n,s){for(var r,i,o;e=e.__;)if((r=e.__c)&&!r.__)try{if((i=r.constructor)&&i.getDerivedStateFromError!=null&&(r.setState(i.getDerivedStateFromError(t)),o=r.__d),r.componentDidCatch!=null&&(r.componentDidCatch(t,s||{}),o=r.__d),o)return r.__E=r}catch(c){t=c}throw t}},St=0,A.prototype.setState=function(t,e){var n;n=this.__s!=null&&this.__s!=this.state?this.__s:this.__s=U({},this.state),typeof t=="function"&&(t=t(U({},n),this.props)),t&&U(n,t),t!=null&&this.__v&&(e&&this._sb.push(e),Re(this))},A.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),Re(this))},A.prototype.render=$,F=[],kt=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,Tt=function(t,e){return t.__v.__b-e.__v.__b},fe.__r=0,Et=/(PointerCapture)$|Capture$/i,Ue=0,Ce=Ge(!1),Pe=Ge(!0),Ct=0;var kn=0;function R(t,e,n,s,r,i){e||(e={});var o,c,u=e;if("ref"in u)for(c in u={},e)c=="ref"?o=e[c]:u[c]=e[c];var l={type:t,props:u,key:n,ref:o,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--kn,__i:-1,__u:0,__source:r,__self:i};if(typeof t=="function"&&(o=t.defaultProps))for(c in o)u[c]===void 0&&(u[c]=o[c]);return g.vnode&&g.vnode(l),l}const Qe=t=>{let e;const n=new Set,s=(l,f)=>{const a=typeof l=="function"?l(e):l;if(!Object.is(a,e)){const m=e;e=f??(typeof a!="object"||a===null)?a:Object.assign({},e,a),n.forEach(h=>h(e,m))}},r=()=>e,c={setState:s,getState:r,getInitialState:()=>u,subscribe:l=>(n.add(l),()=>n.delete(l))},u=e=t(s,r,c);return c},Tn=t=>t?Qe(t):Qe;var H,S,ke,Xe,V=0,At=[],k=g,Ye=k.__b,Ze=k.__r,Ke=k.diffed,et=k.__c,tt=k.unmount,nt=k.__;function G(t,e){k.__h&&k.__h(S,t,V||e),V=0;var n=S.__H||(S.__H={__:[],__h:[]});return t>=n.__.length&&n.__.push({}),n.__[t]}function Me(t){return V=1,$e(Ht,t)}function $e(t,e,n){var s=G(H++,2);if(s.t=t,!s.__c&&(s.__=[n?n(e):Ht(void 0,e),function(c){var u=s.__N?s.__N[0]:s.__[0],l=s.t(u,c);u!==l&&(s.__N=[l,s.__[1]],s.__c.setState({}))}],s.__c=S,!S.__f)){var r=function(c,u,l){if(!s.__c.__H)return!0;var f=s.__c.__H.__.filter(function(m){return!!m.__c});if(f.every(function(m){return!m.__N}))return!i||i.call(this,c,u,l);var a=s.__c.props!==c;return f.forEach(function(m){if(m.__N){var h=m.__[0];m.__=m.__N,m.__N=void 0,h!==m.__[0]&&(a=!0)}}),i&&i.call(this,c,u,l)||a};S.__f=!0;var i=S.shouldComponentUpdate,o=S.componentWillUpdate;S.componentWillUpdate=function(c,u,l){if(this.__e){var f=i;i=void 0,r(c,u,l),i=f}o&&o.call(this,c,u,l)},S.shouldComponentUpdate=r}return s.__N||s.__}function We(t,e){var n=G(H++,3);!k.__s&&ze(n.__H,e)&&(n.__=t,n.u=e,S.__H.__h.push(n))}function re(t,e){var n=G(H++,4);!k.__s&&ze(n.__H,e)&&(n.__=t,n.u=e,S.__h.push(n))}function Nt(t){return V=5,ge(function(){return{current:t}},[])}function jt(t,e,n){V=6,re(function(){if(typeof t=="function"){var s=t(e());return function(){t(null),s&&typeof s=="function"&&s()}}if(t)return t.current=e(),function(){return t.current=null}},n==null?n:n.concat(t))}function ge(t,e){var n=G(H++,7);return ze(n.__H,e)&&(n.__=t(),n.__H=e,n.__h=t),n.__}function Mt(t,e){return V=8,ge(function(){return t},e)}function $t(t){var e=S.context[t.__c],n=G(H++,9);return n.c=t,e?(n.__==null&&(n.__=!0,e.sub(S)),e.props.value):t.__}function Wt(t,e){k.useDebugValue&&k.useDebugValue(e?e(t):t)}function zt(){var t=G(H++,11);if(!t.__){for(var e=S.__v;e!==null&&!e.__m&&e.__!==null;)e=e.__;var n=e.__m||(e.__m=[0,0]);t.__="P"+n[0]+"-"+n[1]++}return t.__}function En(){for(var t;t=At.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(le),t.__H.__h.forEach(Ie),t.__H.__h=[]}catch(e){t.__H.__h=[],k.__e(e,t.__v)}}k.__b=function(t){S=null,Ye&&Ye(t)},k.__=function(t,e){t&&e.__k&&e.__k.__m&&(t.__m=e.__k.__m),nt&&nt(t,e)},k.__r=function(t){Ze&&Ze(t),H=0;var e=(S=t.__c).__H;e&&(ke===S?(e.__h=[],S.__h=[],e.__.forEach(function(n){n.__N&&(n.__=n.__N),n.u=n.__N=void 0})):(e.__h.forEach(le),e.__h.forEach(Ie),e.__h=[],H=0)),ke=S},k.diffed=function(t){Ke&&Ke(t);var e=t.__c;e&&e.__H&&(e.__H.__h.length&&(At.push(e)!==1&&Xe===k.requestAnimationFrame||((Xe=k.requestAnimationFrame)||Cn)(En)),e.__H.__.forEach(function(n){n.u&&(n.__H=n.u),n.u=void 0})),ke=S=null},k.__c=function(t,e){e.some(function(n){try{n.__h.forEach(le),n.__h=n.__h.filter(function(s){return!s.__||Ie(s)})}catch(s){e.some(function(r){r.__h&&(r.__h=[])}),e=[],k.__e(s,n.__v)}}),et&&et(t,e)},k.unmount=function(t){tt&&tt(t);var e,n=t.__c;n&&n.__H&&(n.__H.__.forEach(function(s){try{le(s)}catch(r){e=r}}),n.__H=void 0,e&&k.__e(e,n.__v))};var st=typeof requestAnimationFrame=="function";function Cn(t){var e,n=function(){clearTimeout(s),st&&cancelAnimationFrame(e),setTimeout(t)},s=setTimeout(n,35);st&&(e=requestAnimationFrame(n))}function le(t){var e=S,n=t.__c;typeof n=="function"&&(t.__c=void 0,n()),S=e}function Ie(t){var e=S;t.__c=t.__(),S=e}function ze(t,e){return!t||t.length!==e.length||e.some(function(n,s){return n!==t[s]})}function Ht(t,e){return typeof e=="function"?e(t):e}function Ft(t,e){for(var n in e)t[n]=e[n];return t}function xe(t,e){for(var n in t)if(n!=="__source"&&!(n in e))return!0;for(var s in e)if(s!=="__source"&&t[s]!==e[s])return!0;return!1}function qt(t,e){var n=e(),s=Me({t:{__:n,u:e}}),r=s[0].t,i=s[1];return re(function(){r.__=n,r.u=e,Te(r)&&i({t:r})},[t,n,e]),We(function(){return Te(r)&&i({t:r}),t(function(){Te(r)&&i({t:r})})},[t]),n}function Te(t){var e,n,s=t.u,r=t.__;try{var i=s();return!((e=r)===(n=i)&&(e!==0||1/e==1/n)||e!=e&&n!=n)}catch{return!0}}function Bt(t){t()}function Jt(t){return t}function Vt(){return[!1,Bt]}var Gt=re;function De(t,e){this.props=t,this.context=e}function Pn(t,e){function n(r){var i=this.props.ref,o=i==r.ref;return!o&&i&&(i.call?i(null):i.current=null),e?!e(this.props,r)||!o:xe(this.props,r)}function s(r){return this.shouldComponentUpdate=n,M(t,r)}return s.displayName="Memo("+(t.displayName||t.name)+")",s.prototype.isReactComponent=!0,s.__f=!0,s.type=t,s}(De.prototype=new A).isPureReactComponent=!0,De.prototype.shouldComponentUpdate=function(t,e){return xe(this.props,t)||xe(this.state,e)};var rt=g.__b;g.__b=function(t){t.type&&t.type.__f&&t.ref&&(t.props.ref=t.ref,t.ref=null),rt&&rt(t)};var Rn=typeof Symbol<"u"&&Symbol.for&&Symbol.for("react.forward_ref")||3911;function On(t){function e(n){var s=Ft({},n);return delete s.ref,t(s,n.ref||null)}return e.$$typeof=Rn,e.render=t,e.prototype.isReactComponent=e.__f=!0,e.displayName="ForwardRef("+(t.displayName||t.name)+")",e}var it=function(t,e){return t==null?null:j(j(t).map(e))},In={map:it,forEach:it,count:function(t){return t?j(t).length:0},only:function(t){var e=j(t);if(e.length!==1)throw"Children.only";return e[0]},toArray:j},xn=g.__e;g.__e=function(t,e,n,s){if(t.then){for(var r,i=e;i=i.__;)if((r=i.__c)&&r.__c)return e.__e==null&&(e.__e=n.__e,e.__k=n.__k),r.__c(t,e)}xn(t,e,n,s)};var ot=g.unmount;function Qt(t,e,n){return t&&(t.__c&&t.__c.__H&&(t.__c.__H.__.forEach(function(s){typeof s.__c=="function"&&s.__c()}),t.__c.__H=null),(t=Ft({},t)).__c!=null&&(t.__c.__P===n&&(t.__c.__P=e),t.__c.__e=!0,t.__c=null),t.__k=t.__k&&t.__k.map(function(s){return Qt(s,e,n)})),t}function Xt(t,e,n){return t&&n&&(t.__v=null,t.__k=t.__k&&t.__k.map(function(s){return Xt(s,e,n)}),t.__c&&t.__c.__P===e&&(t.__e&&n.appendChild(t.__e),t.__c.__e=!0,t.__c.__P=n)),t}function _e(){this.__u=0,this.o=null,this.__b=null}function Yt(t){var e=t.__.__c;return e&&e.__a&&e.__a(t)}function Dn(t){var e,n,s;function r(i){if(e||(e=t()).then(function(o){n=o.default||o},function(o){s=o}),s)throw s;if(!n)throw e;return M(n,i)}return r.displayName="Lazy",r.__f=!0,r}function Y(){this.i=null,this.l=null}g.unmount=function(t){var e=t.__c;e&&e.__R&&e.__R(),e&&32&t.__u&&(t.type=null),ot&&ot(t)},(_e.prototype=new A).__c=function(t,e){var n=e.__c,s=this;s.o==null&&(s.o=[]),s.o.push(n);var r=Yt(s.__v),i=!1,o=function(){i||(i=!0,n.__R=null,r?r(c):c())};n.__R=o;var c=function(){if(!--s.__u){if(s.state.__a){var u=s.state.__a;s.__v.__k[0]=Xt(u,u.__c.__P,u.__c.__O)}var l;for(s.setState({__a:s.__b=null});l=s.o.pop();)l.forceUpdate()}};s.__u++||32&e.__u||s.setState({__a:s.__b=s.__v.__k[0]}),t.then(o,o)},_e.prototype.componentWillUnmount=function(){this.o=[]},_e.prototype.render=function(t,e){if(this.__b){if(this.__v.__k){var n=document.createElement("div"),s=this.__v.__k[0].__c;this.__v.__k[0]=Qt(this.__b,n,s.__O=s.__P)}this.__b=null}var r=e.__a&&M($,null,t.fallback);return r&&(r.__u&=-33),[M($,null,e.__a?null:t.children),r]};var ct=function(t,e,n){if(++n[1]===n[0]&&t.l.delete(e),t.props.revealOrder&&(t.props.revealOrder[0]!=="t"||!t.l.size))for(n=t.i;n;){for(;n.length>3;)n.pop()();if(n[1]<n[0])break;t.i=n=n[2]}};function Ln(t){return this.getChildContext=function(){return t.context},t.children}function Un(t){var e=this,n=t.h;if(e.componentWillUnmount=function(){te(null,e.v),e.v=null,e.h=null},e.h&&e.h!==n&&e.componentWillUnmount(),!e.v){for(var s=e.__v;s!==null&&!s.__m&&s.__!==null;)s=s.__;e.h=n,e.v={nodeType:1,parentNode:n,childNodes:[],__k:{__m:s.__m},contains:function(){return!0},insertBefore:function(r,i){this.childNodes.push(r),e.h.insertBefore(r,i)},removeChild:function(r){this.childNodes.splice(this.childNodes.indexOf(r)>>>1,1),e.h.removeChild(r)}}}te(M(Ln,{context:e.context},t.__v),e.v)}function An(t,e){var n=M(Un,{__v:t,h:e});return n.containerInfo=e,n}(Y.prototype=new A).__a=function(t){var e=this,n=Yt(e.__v),s=e.l.get(t);return s[0]++,function(r){var i=function(){e.props.revealOrder?(s.push(r),ct(e,t,s)):r()};n?n(i):i()}},Y.prototype.render=function(t){this.i=null,this.l=new Map;var e=j(t.children);t.revealOrder&&t.revealOrder[0]==="b"&&e.reverse();for(var n=e.length;n--;)this.l.set(e[n],this.i=[1,0,this.i]);return t.children},Y.prototype.componentDidUpdate=Y.prototype.componentDidMount=function(){var t=this;this.l.forEach(function(e,n){ct(t,n,e)})};var Zt=typeof Symbol<"u"&&Symbol.for&&Symbol.for("react.element")||60103,Nn=/^(?:accent|alignment|arabic|baseline|cap|clip(?!PathU)|color|dominant|fill|flood|font|glyph(?!R)|horiz|image(!S)|letter|lighting|marker(?!H|W|U)|overline|paint|pointer|shape|stop|strikethrough|stroke|text(?!L)|transform|underline|unicode|units|v|vector|vert|word|writing|x(?!C))[A-Z]/,jn=/^on(Ani|Tra|Tou|BeforeInp|Compo)/,Mn=/[A-Z0-9]/g,$n=typeof document<"u",Wn=function(t){return(typeof Symbol<"u"&&typeof Symbol()=="symbol"?/fil|che|rad/:/fil|che|ra/).test(t)};function Kt(t,e,n){return e.__k==null&&(e.textContent=""),te(t,e),typeof n=="function"&&n(),t?t.__c:null}function zn(t,e,n){return Ut(t,e),typeof n=="function"&&n(),t?t.__c:null}A.prototype.isReactComponent={},["componentWillMount","componentWillReceiveProps","componentWillUpdate"].forEach(function(t){Object.defineProperty(A.prototype,t,{configurable:!0,get:function(){return this["UNSAFE_"+t]},set:function(e){Object.defineProperty(this,t,{configurable:!0,writable:!0,value:e})}})});var at=g.event;function Hn(){}function Fn(){return this.cancelBubble}function qn(){return this.defaultPrevented}g.event=function(t){return at&&(t=at(t)),t.persist=Hn,t.isPropagationStopped=Fn,t.isDefaultPrevented=qn,t.nativeEvent=t};var He,Bn={enumerable:!1,configurable:!0,get:function(){return this.class}},ut=g.vnode;g.vnode=function(t){typeof t.type=="string"&&(function(e){var n=e.props,s=e.type,r={},i=s.indexOf("-")===-1;for(var o in n){var c=n[o];if(!(o==="value"&&"defaultValue"in n&&c==null||$n&&o==="children"&&s==="noscript"||o==="class"||o==="className")){var u=o.toLowerCase();o==="defaultValue"&&"value"in n&&n.value==null?o="value":o==="download"&&c===!0?c="":u==="translate"&&c==="no"?c=!1:u[0]==="o"&&u[1]==="n"?u==="ondoubleclick"?o="ondblclick":u!=="onchange"||s!=="input"&&s!=="textarea"||Wn(n.type)?u==="onfocus"?o="onfocusin":u==="onblur"?o="onfocusout":jn.test(o)&&(o=u):u=o="oninput":i&&Nn.test(o)?o=o.replace(Mn,"-$&").toLowerCase():c===null&&(c=void 0),u==="oninput"&&r[o=u]&&(o="oninputCapture"),r[o]=c}}s=="select"&&r.multiple&&Array.isArray(r.value)&&(r.value=j(n.children).forEach(function(l){l.props.selected=r.value.indexOf(l.props.value)!=-1})),s=="select"&&r.defaultValue!=null&&(r.value=j(n.children).forEach(function(l){l.props.selected=r.multiple?r.defaultValue.indexOf(l.props.value)!=-1:r.defaultValue==l.props.value})),n.class&&!n.className?(r.class=n.class,Object.defineProperty(r,"className",Bn)):(n.className&&!n.class||n.class&&n.className)&&(r.class=r.className=n.className),e.props=r})(t),t.$$typeof=Zt,ut&&ut(t)};var lt=g.__r;g.__r=function(t){lt&&lt(t),He=t.__c};var _t=g.diffed;g.diffed=function(t){_t&&_t(t);var e=t.props,n=t.__e;n!=null&&t.type==="textarea"&&"value"in e&&e.value!==n.value&&(n.value=e.value==null?"":e.value),He=null};var Jn={ReactCurrentDispatcher:{current:{readContext:function(t){return He.__n[t.__c].props.value},useCallback:Mt,useContext:$t,useDebugValue:Wt,useDeferredValue:Jt,useEffect:We,useId:zt,useImperativeHandle:jt,useInsertionEffect:Gt,useLayoutEffect:re,useMemo:ge,useReducer:$e,useRef:Nt,useState:Me,useSyncExternalStore:qt,useTransition:Vt}}};function Vn(t){return M.bind(null,t)}function ve(t){return!!t&&t.$$typeof===Zt}function Gn(t){return ve(t)&&t.type===$}function Qn(t){return!!t&&!!t.displayName&&(typeof t.displayName=="string"||t.displayName instanceof String)&&t.displayName.startsWith("Memo(")}function Xn(t){return ve(t)?wn.apply(null,arguments):t}function en(t){return!!t.__k&&(te(null,t),!0)}function Yn(t){return t&&(t.base||t.nodeType===1&&t)||null}var Zn=function(t,e){return t(e)},Kn=function(t,e){return t(e)},es=$,ts=ve,ae={useState:Me,useId:zt,useReducer:$e,useEffect:We,useLayoutEffect:re,useInsertionEffect:Gt,useTransition:Vt,useDeferredValue:Jt,useSyncExternalStore:qt,startTransition:Bt,useRef:Nt,useImperativeHandle:jt,useMemo:ge,useCallback:Mt,useContext:$t,useDebugValue:Wt,version:"18.3.1",Children:In,render:Kt,hydrate:zn,unmountComponentAtNode:en,createPortal:An,createElement:M,createContext:Sn,createFactory:Vn,cloneElement:Xn,createRef:mn,Fragment:$,isValidElement:ve,isElement:ts,isFragment:Gn,isMemo:Qn,findDOMNode:Yn,Component:A,PureComponent:De,memo:Pn,forwardRef:On,flushSync:Kn,unstable_batchedUpdates:Zn,StrictMode:es,Suspense:_e,SuspenseList:Y,lazy:Dn,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:Jn};const ns=t=>t;function ss(t,e=ns){const n=ae.useSyncExternalStore(t.subscribe,ae.useCallback(()=>e(t.getState()),[t,e]),ae.useCallback(()=>e(t.getInitialState()),[t,e]));return ae.useDebugValue(n),n}const ht=t=>{const e=Tn(t),n=s=>ss(e,s);return Object.assign(n,e),n},tn=t=>t?ht(t):ht;function D(...t){console.log(...t)}function rs(t,e){const n={iceRestart:!0,offerToReceiveAudio:!0,offerToReceiveVideo:!0},s=new RTCPeerConnection(window.cfg),r={peerConnection:s,localUserId:t,remoteUserId:e};async function i(){const a=await s.createOffer(n);return await s.setLocalDescription(new RTCSessionDescription(a)),s.localDescription}async function o(a){await s.setRemoteDescription(a);const m=await s.createAnswer(n);return await s.setLocalDescription(new RTCSessionDescription(m)),s.localDescription}async function c(a){await s.setRemoteDescription(a)}async function u(a){await s.addIceCandidate(a)}function l(){s.close()}async function f(a){s.getSenders().forEach(m=>s.removeTrack(m)),a.forEach(m=>s.addTrack(m))}return{state:r,createOffer:i,receiveOffer:o,receiveAnswer:c,disconnect:l,iceCandidate:u,updateTracks:f}}class ue{}const T={socket:null,socketId:null,connected:!1,taskQueue:[],listeners:new Map,emitters:new Map};function is(t,e){return Object.entries(t).forEach(n=>{n[1].eventName=n[0],n[1].transform=e}),t}function os(...t){}function O(t,e,n,s){function r(i){return i instanceof n?i:new n(function(o){o(i)})}return new(n||(n=Promise))(function(i,o){function c(f){try{l(s.next(f))}catch(a){o(a)}}function u(f){try{l(s.throw(f))}catch(a){o(a)}}function l(f){f.done?i(f.value):r(f.value).then(c,u)}l((s=s.apply(t,[])).next())})}function cs(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Fe={exports:{}},B=typeof Reflect=="object"?Reflect:null,ft=B&&typeof B.apply=="function"?B.apply:function(e,n,s){return Function.prototype.apply.call(e,n,s)},he;B&&typeof B.ownKeys=="function"?he=B.ownKeys:Object.getOwnPropertySymbols?he=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:he=function(e){return Object.getOwnPropertyNames(e)};function as(t){console&&console.warn&&console.warn(t)}var nn=Number.isNaN||function(e){return e!==e};function y(){y.init.call(this)}Fe.exports=y;Fe.exports.once=hs;y.EventEmitter=y;y.prototype._events=void 0;y.prototype._eventsCount=0;y.prototype._maxListeners=void 0;var dt=10;function ye(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(y,"defaultMaxListeners",{enumerable:!0,get:function(){return dt},set:function(t){if(typeof t!="number"||t<0||nn(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");dt=t}});y.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};y.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||nn(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function sn(t){return t._maxListeners===void 0?y.defaultMaxListeners:t._maxListeners}y.prototype.getMaxListeners=function(){return sn(this)};y.prototype.emit=function(e){for(var n=[],s=1;s<arguments.length;s++)n.push(arguments[s]);var r=e==="error",i=this._events;if(i!==void 0)r=r&&i.error===void 0;else if(!r)return!1;if(r){var o;if(n.length>0&&(o=n[0]),o instanceof Error)throw o;var c=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw c.context=o,c}var u=i[e];if(u===void 0)return!1;if(typeof u=="function")ft(u,this,n);else for(var l=u.length,f=un(u,l),s=0;s<l;++s)ft(f[s],this,n);return!0};function rn(t,e,n,s){var r,i,o;if(ye(n),i=t._events,i===void 0?(i=t._events=Object.create(null),t._eventsCount=0):(i.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),i=t._events),o=i[e]),o===void 0)o=i[e]=n,++t._eventsCount;else if(typeof o=="function"?o=i[e]=s?[n,o]:[o,n]:s?o.unshift(n):o.push(n),r=sn(t),r>0&&o.length>r&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=t,c.type=e,c.count=o.length,as(c)}return t}y.prototype.addListener=function(e,n){return rn(this,e,n,!1)};y.prototype.on=y.prototype.addListener;y.prototype.prependListener=function(e,n){return rn(this,e,n,!0)};function us(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function on(t,e,n){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},r=us.bind(s);return r.listener=n,s.wrapFn=r,r}y.prototype.once=function(e,n){return ye(n),this.on(e,on(this,e,n)),this};y.prototype.prependOnceListener=function(e,n){return ye(n),this.prependListener(e,on(this,e,n)),this};y.prototype.removeListener=function(e,n){var s,r,i,o,c;if(ye(n),r=this._events,r===void 0)return this;if(s=r[e],s===void 0)return this;if(s===n||s.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,s.listener||n));else if(typeof s!="function"){for(i=-1,o=s.length-1;o>=0;o--)if(s[o]===n||s[o].listener===n){c=s[o].listener,i=o;break}if(i<0)return this;i===0?s.shift():ls(s,i),s.length===1&&(r[e]=s[0]),r.removeListener!==void 0&&this.emit("removeListener",e,c||n)}return this};y.prototype.off=y.prototype.removeListener;y.prototype.removeAllListeners=function(e){var n,s,r;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var i=Object.keys(s),o;for(r=0;r<i.length;++r)o=i[r],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=s[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(r=n.length-1;r>=0;r--)this.removeListener(e,n[r]);return this};function cn(t,e,n){var s=t._events;if(s===void 0)return[];var r=s[e];return r===void 0?[]:typeof r=="function"?n?[r.listener||r]:[r]:n?_s(r):un(r,r.length)}y.prototype.listeners=function(e){return cn(this,e,!0)};y.prototype.rawListeners=function(e){return cn(this,e,!1)};y.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):an.call(t,e)};y.prototype.listenerCount=an;function an(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}y.prototype.eventNames=function(){return this._eventsCount>0?he(this._events):[]};function un(t,e){for(var n=new Array(e),s=0;s<e;++s)n[s]=t[s];return n}function ls(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function _s(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function hs(t,e){return new Promise(function(n,s){function r(o){t.removeListener(e,i),s(o)}function i(){typeof t.removeListener=="function"&&t.removeListener("error",r),n([].slice.call(arguments))}ln(t,e,i,{once:!0}),e!=="error"&&fs(t,r,{once:!0})})}function fs(t,e,n){typeof t.on=="function"&&ln(t,"error",e,n)}function ln(t,e,n,s){if(typeof t.on=="function")s.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function r(i){s.once&&t.removeEventListener(e,r),n(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}var ds=Fe.exports,_n=cs(ds),w;(function(t){t[t.timeout=1]="timeout",t[t.transportClosed=2]="transportClosed",t[t.clientDisconnected=3]="clientDisconnected",t[t.clientClosed=4]="clientClosed",t[t.clientConnectToken=5]="clientConnectToken",t[t.clientRefreshToken=6]="clientRefreshToken",t[t.subscriptionUnsubscribed=7]="subscriptionUnsubscribed",t[t.subscriptionSubscribeToken=8]="subscriptionSubscribeToken",t[t.subscriptionRefreshToken=9]="subscriptionRefreshToken",t[t.transportWriteError=10]="transportWriteError",t[t.connectionClosed=11]="connectionClosed",t[t.badConfiguration=12]="badConfiguration"})(w||(w={}));var z;(function(t){t[t.connectCalled=0]="connectCalled",t[t.transportClosed=1]="transportClosed",t[t.noPing=2]="noPing",t[t.subscribeTimeout=3]="subscribeTimeout",t[t.unsubscribeError=4]="unsubscribeError"})(z||(z={}));var K;(function(t){t[t.disconnectCalled=0]="disconnectCalled",t[t.unauthorized=1]="unauthorized",t[t.badProtocol=2]="badProtocol",t[t.messageSizeLimit=3]="messageSizeLimit"})(K||(K={}));var de;(function(t){t[t.subscribeCalled=0]="subscribeCalled",t[t.transportClosed=1]="transportClosed"})(de||(de={}));var pe;(function(t){t[t.unsubscribeCalled=0]="unsubscribeCalled",t[t.unauthorized=1]="unauthorized",t[t.clientClosed=2]="clientClosed"})(pe||(pe={}));var E;(function(t){t.Disconnected="disconnected",t.Connecting="connecting",t.Connected="connected"})(E||(E={}));var P;(function(t){t.Unsubscribed="unsubscribed",t.Subscribing="subscribing",t.Subscribed="subscribed"})(P||(P={}));function ps(t,e){return t.lastIndexOf(e,0)===0}function hn(t){return t==null?!1:typeof t=="function"}function ms(t,e){if(globalThis.console){const n=globalThis.console[t];hn(n)&&n.apply(globalThis.console,e)}}function bs(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function me(t,e,n){t>31&&(t=31);const s=bs(0,Math.min(n,e*Math.pow(2,t)));return Math.min(n,e+s)}function gs(t){return"error"in t&&t.error!==null}function be(t){return Math.min(t*1e3,2147483647)}class vs extends _n{constructor(e,n,s){super(),this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=n,this.state=P.Unsubscribed,this._centrifuge=e,this._token="",this._getToken=null,this._data=null,this._getData=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._delta="",this._delta_negotiated=!1,this._prevValue=null,this._unsubPromise=Promise.resolve(),this._setOptions(s),this._centrifuge._debugEnabled?(this.on("state",r=>{this._debug("subscription state",n,r.oldState,"->",r.newState)}),this.on("error",r=>{this._debug("subscription error",n,r)})):this.on("error",function(){Function.prototype()})}ready(e){return this.state===P.Unsubscribed?Promise.reject({code:w.subscriptionUnsubscribed,message:this.state}):this.state===P.Subscribed?Promise.resolve():new Promise((n,s)=>{const r={resolve:n,reject:s};e&&(r.timeout=setTimeout(function(){s({code:w.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=r})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(de.subscribeCalled,"subscribe called"))}unsubscribe(){this._unsubPromise=this._setUnsubscribed(pe.unsubscribeCalled,"unsubscribe called",!0)}publish(e){return O(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.publish(this.channel,e)})}presence(){return O(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.presence(this.channel)})}presenceStats(){return O(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.presenceStats(this.channel)})}history(e){return O(this,void 0,void 0,function*(){return yield this._methodCall(),this._centrifuge.history(this.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:w.subscriptionUnsubscribed,message:this.state}):new Promise((e,n)=>{const s=this._centrifuge._config.timeout,r=setTimeout(()=>{n({code:w.timeout,message:"timeout"})},s);this._promises[this._nextPromiseId()]={timeout:r,resolve:e,reject:n}})}_nextPromiseId(){return++this._promiseId}_needRecover(){return this._recover===!0}_isUnsubscribed(){return this.state===P.Unsubscribed}_isSubscribing(){return this.state===P.Subscribing}_isSubscribed(){return this.state===P.Subscribed}_setState(e){if(this.state!==e){const n=this.state;return this.state=e,this.emit("state",{newState:e,oldState:n,channel:this.channel}),!0}return!1}_usesToken(){return this._token!==""||this._getToken!==null}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(e){if(!this._isSubscribing())return;this._clearSubscribingState(),e.recoverable&&(this._recover=!0,this._offset=e.offset||0,this._epoch=e.epoch||""),e.delta?this._delta_negotiated=!0:this._delta_negotiated=!1,this._setState(P.Subscribed);const n=this._centrifuge._getSubscribeContext(this.channel,e);this.emit("subscribed",n),this._resolvePromises();const s=e.publications;if(s&&s.length>0)for(const r in s)s.hasOwnProperty(r)&&this._handlePublication(s[r]);e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),be(e.ttl)))}_setSubscribing(e,n){return O(this,void 0,void 0,function*(){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState(P.Subscribing)&&this.emit("subscribing",{channel:this.channel,code:e,reason:n}),this._centrifuge._transport&&this._centrifuge._transport.emulation()&&(yield this._unsubPromise),this._isSubscribing()&&this._subscribe())})}_subscribe(){return this._debug("subscribing on",this.channel),this._isTransportOpen()?this._inflight?null:(this._inflight=!0,this._canSubscribeWithoutGettingToken()?this._subscribeWithoutToken():(this._getSubscriptionToken().then(e=>this._handleTokenResponse(e)).catch(e=>this._handleTokenError(e)),null)):(this._debug("delay subscribe on",this.channel,"till connected"),null)}_isTransportOpen(){return this._centrifuge._transportIsOpen}_canSubscribeWithoutGettingToken(){return!this._usesToken()||!!this._token}_subscribeWithoutToken(){return this._getData?(this._getDataAndSubscribe(this._token),null):this._sendSubscribe(this._token)}_getDataAndSubscribe(e){if(!this._getData){this._inflight=!1;return}this._getData({channel:this.channel}).then(n=>{if(!this._isSubscribing()){this._inflight=!1;return}this._data=n,this._sendSubscribe(e)}).catch(n=>this._handleGetDataError(n))}_handleGetDataError(e){if(!this._isSubscribing()){this._inflight=!1;return}if(e instanceof N){this._inflight=!1,this._failUnauthorized();return}this.emit("error",{type:"subscribeData",channel:this.channel,error:{code:w.badConfiguration,message:e?.toString()||""}}),this._inflight=!1,this._scheduleResubscribe()}_handleTokenResponse(e){if(!this._isSubscribing()){this._inflight=!1;return}if(!e){this._inflight=!1,this._failUnauthorized();return}this._token=e,this._getData?this._getDataAndSubscribe(e):this._sendSubscribe(e)}_handleTokenError(e){if(!this._isSubscribing()){this._inflight=!1;return}if(e instanceof N){this._inflight=!1,this._failUnauthorized();return}this.emit("error",{type:"subscribeToken",channel:this.channel,error:{code:w.subscriptionSubscribeToken,message:e?.toString()||""}}),this._inflight=!1,this._scheduleResubscribe()}_sendSubscribe(e){if(!this._isTransportOpen())return this._inflight=!1,null;const n=this._buildSubscribeCommand(e);return this._centrifuge._call(n).then(s=>{this._inflight=!1;const r=s.reply.subscribe;this._handleSubscribeResponse(r),s.next&&s.next()},s=>{this._inflight=!1,this._handleSubscribeError(s.error),s.next&&s.next()}),n}_buildSubscribeCommand(e){const n={channel:this.channel};if(e&&(n.token=e),this._data&&(n.data=this._data),this._positioned&&(n.positioned=!0),this._recoverable&&(n.recoverable=!0),this._joinLeave&&(n.join_leave=!0),this._needRecover()){n.recover=!0;const s=this._getOffset();s&&(n.offset=s);const r=this._getEpoch();r&&(n.epoch=r)}return this._delta&&(n.delta=this._delta),{subscribe:n}}_debug(...e){this._centrifuge._debug(...e)}_handleSubscribeError(e){if(this._isSubscribing()){if(e.code===w.timeout){this._centrifuge._disconnect(z.subscribeTimeout,"subscribe timeout",!0);return}this._subscribeError(e)}}_handleSubscribeResponse(e){this._isSubscribing()&&this._setSubscribed(e)}_setUnsubscribed(e,n,s){if(this._isUnsubscribed())return Promise.resolve();let r=Promise.resolve();return this._isSubscribed()?(s&&(r=this._centrifuge._unsubscribe(this)),this._clearSubscribedState()):this._isSubscribing()&&(this._inflight&&s&&(r=this._centrifuge._unsubscribe(this)),this._clearSubscribingState()),this._inflight=!1,this._setState(P.Unsubscribed)&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:n}),this._rejectPromises({code:w.subscriptionUnsubscribed,message:this.state}),r}_handlePublication(e){if(this._delta&&this._delta_negotiated){const{newData:s,newPrevValue:r}=this._centrifuge._codec.applyDeltaIfNeeded(e,this._prevValue);e.data=s,this._prevValue=r}const n=this._centrifuge._getPublicationContext(this.channel,e);this.emit("publication",n),e.offset&&(this._offset=e.offset)}_handleJoin(e){const n=this._centrifuge._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:n})}_handleLeave(e){const n=this._centrifuge._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:n})}_resolvePromises(){for(const e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(const n in this._promises)this._promises.hasOwnProperty(n)&&(this._promises[n].timeout&&clearTimeout(this._promises[n].timeout),this._promises[n].reject(e),delete this._promises[n])}_scheduleResubscribe(){if(!this._isSubscribing()){this._debug("not in subscribing state, skip resubscribe scheduling",this.channel);return}const e=this,n=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe()},n),this._debug("resubscribe scheduled after "+n,this.channel)}_subscribeError(e){if(this._isSubscribing())if(e.code<100||e.code===109||e.temporary===!0){e.code===109&&(this._token="");const n={channel:this.channel,type:"subscribe",error:e};this._centrifuge.state===E.Connected&&this.emit("error",n),this._scheduleResubscribe()}else this._setUnsubscribed(e.code,e.message,!1)}_getResubscribeDelay(){const e=me(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){if(e&&(e.since&&(this._offset=e.since.offset||0,this._epoch=e.since.epoch||"",this._recover=!0),e.data&&(this._data=e.data),e.getData&&(this._getData=e.getData),e.minResubscribeDelay!==void 0&&(this._minResubscribeDelay=e.minResubscribeDelay),e.maxResubscribeDelay!==void 0&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),e.positioned===!0&&(this._positioned=!0),e.recoverable===!0&&(this._recoverable=!0),e.joinLeave===!0&&(this._joinLeave=!0),e.delta)){if(e.delta!=="fossil")throw new Error("unsupported delta format");this._delta=e.delta}}_getOffset(){const e=this._offset;return e!==null?e:0}_getEpoch(){const e=this._epoch;return e!==null?e:""}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){this._resubscribeTimeout!==null&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._debug("get subscription token for channel",this.channel);const e={channel:this.channel},n=this._getToken;return n===null?(this.emit("error",{type:"configuration",channel:this.channel,error:{code:w.badConfiguration,message:"provide a function to get channel subscription token"}}),Promise.reject(new N(""))):n(e)}_refresh(){this._clearRefreshTimeout();const e=this;this._getSubscriptionToken().then(function(n){if(!e._isSubscribed())return;if(!n){e._failUnauthorized();return}e._token=n;const r={sub_refresh:{channel:e.channel,token:n}};e._centrifuge._call(r).then(i=>{const o=i.reply.sub_refresh;e._refreshResponse(o),i.next&&i.next()},i=>{e._refreshError(i.error),i.next&&i.next()})}).catch(function(n){if(n instanceof N){e._failUnauthorized();return}e.emit("error",{type:"refreshToken",channel:e.channel,error:{code:w.subscriptionRefreshToken,message:n!==void 0?n.toString():""}}),e._refreshTimeout=setTimeout(()=>e._refresh(),e._getRefreshRetryDelay())})}_refreshResponse(e){this._isSubscribed()&&(this._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),e.expires===!0&&(this._refreshTimeout=setTimeout(()=>this._refresh(),be(e.ttl))))}_refreshError(e){this._isSubscribed()&&(e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return me(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(pe.unauthorized,"unauthorized",!0)}}class ys{constructor(e,n){this.endpoint=e,this.options=n,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return this.options.sockjs!==null}initialize(e,n){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{n.onOpen()},this._transport.onerror=s=>{n.onError(s)},this._transport.onclose=s=>{n.onClose(s)},this._transport.onmessage=s=>{n.onMessage(s.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}}class pt{constructor(e,n){this.endpoint=e,this.options=n,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return this.options.websocket!==void 0&&this.options.websocket!==null}initialize(e,n){let s="";e==="protobuf"&&(s="centrifuge-protobuf"),s!==""?this._transport=new this.options.websocket(this.endpoint,s):this._transport=new this.options.websocket(this.endpoint),e==="protobuf"&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{n.onOpen()},this._transport.onerror=r=>{n.onError(r)},this._transport.onclose=r=>{n.onClose(r)},this._transport.onmessage=r=>{n.onMessage(r.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}}class ws{constructor(e,n){this.endpoint=e,this.options=n,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(!e.ok)throw new Error(e.status);return e}_fetchEventTarget(e,n,s){const r=new EventTarget,i=e.options.fetch;return i(n,s).then(e._handleErrors).then(o=>{r.dispatchEvent(new Event("open"));let c="",u=0,l=new Uint8Array;const f=o.body.getReader();return new e.options.readableStream({start(a){function m(){return f.read().then(({done:h,value:_})=>{if(h){r.dispatchEvent(new Event("close")),a.close();return}try{if(e._protocol==="json")for(c+=e._utf8decoder.decode(_);u<c.length;)if(c[u]===`
`){const d=c.substring(0,u);r.dispatchEvent(new MessageEvent("message",{data:d})),c=c.substring(u+1),u=0}else++u;else{const d=new Uint8Array(l.length+_.length);for(d.set(l),d.set(_,l.length),l=d;;){const p=e.options.decoder.decodeReply(l);if(p.ok){const b=l.slice(0,p.pos);r.dispatchEvent(new MessageEvent("message",{data:b})),l=l.slice(p.pos);continue}break}}}catch(d){r.dispatchEvent(new Event("error",{detail:d})),r.dispatchEvent(new Event("close")),a.close();return}m()}).catch(function(h){r.dispatchEvent(new Event("error",{detail:h})),r.dispatchEvent(new Event("close")),a.close()})}return m()}})}).catch(o=>{r.dispatchEvent(new Event("error",{detail:o})),r.dispatchEvent(new Event("close"))}),r}supported(){return this.options.fetch!==null&&this.options.readableStream!==null&&typeof TextDecoder<"u"&&typeof AbortController<"u"&&typeof EventTarget<"u"&&typeof Event<"u"&&typeof MessageEvent<"u"&&typeof Error<"u"}initialize(e,n,s){this._protocol=e,this._abortController=new AbortController;let r,i;e==="json"?(r={Accept:"application/json","Content-Type":"application/json"},i=s):(r={Accept:"application/octet-stream","Content-Type":"application/octet-stream"},i=s);const o={method:"POST",headers:r,body:i,mode:"cors",credentials:"same-origin",signal:this._abortController.signal},c=this._fetchEventTarget(this,this.endpoint,o);c.addEventListener("open",()=>{n.onOpen()}),c.addEventListener("error",u=>{this._abortController.abort(),n.onError(u)}),c.addEventListener("close",()=>{this._abortController.abort(),n.onClose({code:4,reason:"connection closed"})}),c.addEventListener("message",u=>{n.onMessage(u.data)})}close(){this._abortController.abort()}send(e,n,s){let r,i;const o={session:n,node:s,data:e};this._protocol==="json"?(r={"Content-Type":"application/json"},i=JSON.stringify(o)):(r={"Content-Type":"application/octet-stream"},i=this.options.encoder.encodeEmulationRequest(o));const c=this.options.fetch,u={method:"POST",headers:r,body:i,mode:"cors",credentials:"same-origin"};c(this.options.emulationEndpoint,u)}}class Ss{constructor(e,n){this.endpoint=e,this.options=n,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return this.options.eventsource!==null&&this.options.fetch!==null}initialize(e,n,s){let r;globalThis&&globalThis.document&&globalThis.document.baseURI?r=new URL(this.endpoint,globalThis.document.baseURI):r=new URL(this.endpoint),r.searchParams.append("cf_connect",s);const i={},o=new this.options.eventsource(r.toString(),i);this._transport=o;const c=this;o.onopen=function(){n.onOpen()},o.onerror=function(u){o.close(),n.onError(u),n.onClose({code:4,reason:"connection closed"})},o.onmessage=function(u){n.onMessage(u.data)},c._onClose=function(){n.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),this._onClose!==null&&this._onClose()}send(e,n,s){const r={session:n,node:s,data:e},i={"Content-Type":"application/json"},o=JSON.stringify(r),c=this.options.fetch,u={method:"POST",headers:i,body:o,mode:"cors",credentials:"same-origin"};c(this.options.emulationEndpoint,u)}}class ks{constructor(e,n){this.endpoint=e,this.options=n,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return this.options.webtransport!==void 0&&this.options.webtransport!==null}initialize(e,n){return O(this,void 0,void 0,function*(){let s;globalThis&&globalThis.document&&globalThis.document.baseURI?s=new URL(this.endpoint,globalThis.document.baseURI):s=new URL(this.endpoint),e==="protobuf"&&s.searchParams.append("cf_protocol","protobuf"),this._protocol=e;const r=new EventTarget;this._transport=new this.options.webtransport(s.toString()),this._transport.closed.then(()=>{n.onClose({code:4,reason:"connection closed"})}).catch(()=>{n.onClose({code:4,reason:"connection closed"})});try{yield this._transport.ready}catch{this.close();return}let i;try{i=yield this._transport.createBidirectionalStream()}catch{this.close();return}this._stream=i,this._writer=this._stream.writable.getWriter(),r.addEventListener("close",()=>{n.onClose({code:4,reason:"connection closed"})}),r.addEventListener("message",o=>{n.onMessage(o.data)}),this._startReading(r),n.onOpen()})}_startReading(e){return O(this,void 0,void 0,function*(){const n=this._stream.readable.getReader();let s="",r=0,i=new Uint8Array;try{for(;;){const{done:o,value:c}=yield n.read();if(c.length>0)if(this._protocol==="json")for(s+=this._utf8decoder.decode(c);r<s.length;)if(s[r]===`
`){const u=s.substring(0,r);e.dispatchEvent(new MessageEvent("message",{data:u})),s=s.substring(r+1),r=0}else++r;else{const u=new Uint8Array(i.length+c.length);for(u.set(i),u.set(c,i.length),i=u;;){const l=this.options.decoder.decodeReply(i);if(l.ok){const f=i.slice(0,l.pos);e.dispatchEvent(new MessageEvent("message",{data:f})),i=i.slice(l.pos);continue}break}}if(o)break}}catch{e.dispatchEvent(new Event("close"))}})}close(){return O(this,void 0,void 0,function*(){try{this._writer&&(yield this._writer.close()),this._transport.close()}catch{}})}send(e){return O(this,void 0,void 0,function*(){let n;this._protocol==="json"?n=new TextEncoder().encode(e+`
`):n=e;try{yield this._writer.write(n)}catch{this.close()}})}}const Ts=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,-1,-1,-1,-1,-1,-1,-1,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,-1,-1,-1,-1,36,-1,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,-1,-1,-1,63,-1];class Es{constructor(e){this.a=e,this.pos=0}haveBytes(){return this.pos<this.a.length}getByte(){const e=this.a[this.pos];if(this.pos++,this.pos>this.a.length)throw new RangeError("out of bounds");return e}getChar(){return String.fromCharCode(this.getByte())}getInt(){let e=0,n;for(;this.haveBytes()&&(n=Ts[127&this.getByte()])>=0;)e=(e<<6)+n;return this.pos--,e>>>0}}class Cs{constructor(){this.a=[]}toByteArray(e){return Array.isArray(e)?this.a:new Uint8Array(this.a)}putArray(e,n,s){for(let r=n;r<s;r++)this.a.push(e[r])}}function Ps(t){let e=0,n=0,s=0,r=0,i=0,o=t.length;for(;o>=16;)e=e+t[i+0]|0,n=n+t[i+1]|0,s=s+t[i+2]|0,r=r+t[i+3]|0,e=e+t[i+4]|0,n=n+t[i+5]|0,s=s+t[i+6]|0,r=r+t[i+7]|0,e=e+t[i+8]|0,n=n+t[i+9]|0,s=s+t[i+10]|0,r=r+t[i+11]|0,e=e+t[i+12]|0,n=n+t[i+13]|0,s=s+t[i+14]|0,r=r+t[i+15]|0,i+=16,o-=16;for(;o>=4;)e=e+t[i+0]|0,n=n+t[i+1]|0,s=s+t[i+2]|0,r=r+t[i+3]|0,i+=4,o-=4;switch(r=((r+(s<<8)|0)+(n<<16)|0)+(e<<24)|0,o){case 3:r=r+(t[i+2]<<8)|0;case 2:r=r+(t[i+1]<<16)|0;case 1:r=r+(t[i+0]<<24)|0}return r>>>0}function Rs(t,e){let n=0;const s=new Es(e),r=t.length,i=e.length,o=s.getInt();if(s.getChar()!==`
`)throw new Error("size integer not terminated by '\\n'");const c=new Cs;for(;s.haveBytes();){const u=s.getInt();let l;switch(s.getChar()){case"@":if(l=s.getInt(),s.haveBytes()&&s.getChar()!==",")throw new Error("copy command not terminated by ','");if(n+=u,n>o)throw new Error("copy exceeds output file size");if(l+u>r)throw new Error("copy extends past end of input");c.putArray(t,l,l+u);break;case":":if(n+=u,n>o)throw new Error("insert command gives an output larger than predicted");if(u>i)throw new Error("insert count exceeds size of delta");c.putArray(s.a,s.pos,s.pos+u),s.pos+=u;break;case";":{const f=c.toByteArray(t);if(u!==Ps(f))throw new Error("bad checksum");if(n!==o)throw new Error("generated size does not match predicted size");return f}default:throw new Error("unknown delta operator")}}throw new Error("unterminated delta")}class mt{name(){return"json"}encodeCommands(e){return e.map(n=>JSON.stringify(n)).join(`
`)}decodeReplies(e){return e.trim().split(`
`).map(n=>JSON.parse(n))}applyDeltaIfNeeded(e,n){let s,r;if(e.delta){const i=Rs(n,new TextEncoder().encode(e.data));s=JSON.parse(new TextDecoder().decode(i)),r=i}else s=JSON.parse(e.data),r=new TextEncoder().encode(e.data);return{newData:s,newPrevValue:r}}}const Os={headers:{},token:"",getToken:null,data:null,getData:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4,networkEventTarget:null};class N extends Error{constructor(e){super(e),this.name=this.constructor.name}}class we extends _n{constructor(e,n){super(),this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null,this.state=E.Disconnected,this._transportIsOpen=!1,this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportId=0,this._deviceWentOffline=!1,this._transportClosed=!0,this._codec=new mt,this._reconnecting=!1,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token="",this._data=null,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._networkEventsSet=!1,this._config=Object.assign(Object.assign({},Os),n),this._configure(),this._debugEnabled?(this.on("state",s=>{this._debug("client state",s.oldState,"->",s.newState)}),this.on("error",s=>{this._debug("client error",s)})):this.on("error",function(){Function.prototype()})}newSubscription(e,n){if(this.getSubscription(e)!==null)throw new Error("Subscription to the channel "+e+" already exists");const s=new vs(this,e,n);return this._subs[e]=s,s}getSubscription(e){return this._getSub(e)}removeSubscription(e){e&&(e.state!==P.Unsubscribed&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(e){switch(this.state){case E.Disconnected:return Promise.reject({code:w.clientDisconnected,message:"client disconnected"});case E.Connected:return Promise.resolve();default:return new Promise((n,s)=>{const r={resolve:n,reject:s};e&&(r.timeout=setTimeout(()=>{s({code:w.timeout,message:"timeout"})},e)),this._promises[this._nextPromiseId()]=r})}}connect(){if(this._isConnected()){this._debug("connect called when already connected");return}if(this._isConnecting()){this._debug("connect called when already connecting");return}this._debug("connect called"),this._reconnectAttempts=0,this._startConnecting()}disconnect(){this._disconnect(K.disconnectCalled,"disconnect called",!1)}setToken(e){this._token=e}setHeaders(e){this._config.headers=e}send(e){return O(this,void 0,void 0,function*(){const n={send:{data:e}};if(yield this._methodCall(),!this._transportSendCommands([n]))throw this._createErrorObject(w.transportWriteError,"transport write error")})}rpc(e,n){return O(this,void 0,void 0,function*(){const s={rpc:{method:e,data:n}};return yield this._methodCall(),{data:(yield this._callPromise(s,i=>i.rpc)).data}})}publish(e,n){return O(this,void 0,void 0,function*(){const s={publish:{channel:e,data:n}};return yield this._methodCall(),yield this._callPromise(s,()=>({})),{}})}history(e,n){return O(this,void 0,void 0,function*(){const s={history:this._getHistoryRequest(e,n)};yield this._methodCall();const r=yield this._callPromise(s,o=>o.history),i=[];if(r.publications)for(let o=0;o<r.publications.length;o++)i.push(this._getPublicationContext(e,r.publications[o]));return{publications:i,epoch:r.epoch||"",offset:r.offset||0}})}presence(e){return O(this,void 0,void 0,function*(){const n={presence:{channel:e}};yield this._methodCall();const r=(yield this._callPromise(n,i=>i.presence)).presence;for(const i in r)if(Object.prototype.hasOwnProperty.call(r,i)){const o=r[i],c=o.conn_info,u=o.chan_info;c&&(o.connInfo=c),u&&(o.chanInfo=u)}return{clients:r}})}presenceStats(e){return O(this,void 0,void 0,function*(){const n={presence_stats:{channel:e}};yield this._methodCall();const s=yield this._callPromise(n,r=>r.presence_stats);return{numUsers:s.num_users,numClients:s.num_clients}})}startBatching(){this._batching=!0}stopBatching(){const e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...e){this._debugEnabled&&ms("debug",e)}_codecName(){return this._codec.name()}_formatOverride(){}_configure(){if(!("Promise"in globalThis))throw new Error("Promise polyfill required");if(!this._endpoint)throw new Error("endpoint configuration required");if(this._config.token!==null&&(this._token=this._config.token),this._config.data!==null&&(this._data=this._config.data),this._codec=new mt,this._formatOverride(),(this._config.debug===!0||typeof localStorage<"u"&&localStorage.getItem("centrifuge.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),typeof this._endpoint!="string")if(typeof this._endpoint=="object"&&this._endpoint instanceof Array){this._transports=this._endpoint,this._emulation=!0;for(const e in this._transports)if(this._transports.hasOwnProperty(e)){const n=this._transports[e];if(!n.endpoint||!n.transport)throw new Error("malformed transport configuration");const s=n.transport;if(["websocket","http_stream","sse","sockjs","webtransport"].indexOf(s)<0)throw new Error("unsupported transport name: "+s)}}else throw new Error("unsupported url configuration type: only string or array of objects are supported")}_setState(e){if(this.state!==e){this._reconnecting=!1;const n=this.state;return this.state=e,this.emit("state",{newState:e,oldState:n}),!0}return!1}_isDisconnected(){return this.state===E.Disconnected}_isConnecting(){return this.state===E.Connecting}_isConnected(){return this.state===E.Connected}_nextCommandId(){return++this._commandId}_setNetworkEvents(){if(this._networkEventsSet)return;let e=null;this._config.networkEventTarget!==null?e=this._config.networkEventTarget:typeof globalThis.addEventListener<"u"&&(e=globalThis),e&&(e.addEventListener("offline",()=>{this._debug("offline event triggered"),(this.state===E.Connected||this.state===E.Connecting)&&(this._disconnect(z.transportClosed,"transport closed",!0),this._deviceWentOffline=!0)}),e.addEventListener("online",()=>{this._debug("online event triggered"),this.state===E.Connecting&&(this._deviceWentOffline&&!this._transportClosed&&(this._deviceWentOffline=!1,this._transportClosed=!0),this._clearReconnectTimeout(),this._startReconnecting())}),this._networkEventsSet=!0)}_getReconnectDelay(){const e=me(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(const e in this._callbacks)if(this._callbacks.hasOwnProperty(e)){const n=this._callbacks[e];clearTimeout(n.timeout);const s=n.errback;if(!s)continue;s({error:this._createErrorObject(w.connectionClosed,"connection closed")})}this._callbacks={}}_clearConnectedState(){this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout();for(const e in this._subs){if(!this._subs.hasOwnProperty(e))continue;const n=this._subs[e];n.state===P.Subscribed&&n._setSubscribing(de.transportClosed,"transport closed")}for(const e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(const n of e){const s=n.id;if(!(s in this._callbacks))continue;const r=this._callbacks[s];clearTimeout(this._callbacks[s].timeout),delete this._callbacks[s];const i=r.errback;i({error:this._createErrorObject(w.transportWriteError,"transport write error")})}}_transportSendCommands(e){if(!e.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._codec.encodeCommands(e),this._session,this._node)}catch(n){return this._debug("error writing commands",n),this._handleWriteError(e),!1}return!0}_initializeTransport(){let e;this._config.websocket!==null?e=this._config.websocket:typeof globalThis.WebSocket!="function"&&typeof globalThis.WebSocket!="object"||(e=globalThis.WebSocket);let n=null;this._config.sockjs!==null?n=this._config.sockjs:typeof globalThis.SockJS<"u"&&(n=globalThis.SockJS);let s=null;this._config.eventsource!==null?s=this._config.eventsource:typeof globalThis.EventSource<"u"&&(s=globalThis.EventSource);let r=null;this._config.fetch!==null?r=this._config.fetch:typeof globalThis.fetch<"u"&&(r=globalThis.fetch);let i=null;if(this._config.readableStream!==null?i=this._config.readableStream:typeof globalThis.ReadableStream<"u"&&(i=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let h=0;for(;;){if(h>=this._transports.length)throw new Error("no supported transport found");const _=this._transports[this._currentTransportIndex],d=_.transport,p=_.endpoint;if(d==="websocket"){if(this._debug("trying websocket transport"),this._transport=new pt(p,{websocket:e}),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,h++;continue}}else if(d==="webtransport"){if(this._debug("trying webtransport transport"),this._transport=new ks(p,{webtransport:globalThis.WebTransport,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,h++;continue}}else if(d==="http_stream"){if(this._debug("trying http_stream transport"),this._transport=new ws(p,{fetch:r,readableStream:i,emulationEndpoint:this._config.emulationEndpoint,decoder:this._codec,encoder:this._codec}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,h++;continue}}else if(d==="sse"){if(this._debug("trying sse transport"),this._transport=new Ss(p,{eventsource:s,fetch:r,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,h++;continue}}else if(d==="sockjs"){if(this._debug("trying sockjs"),this._transport=new ys(p,{sockjs:n,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,h++;continue}}else throw new Error("unknown transport "+d);break}}else{if(ps(this._endpoint,"http"))throw new Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");if(this._debug("client will use websocket"),this._transport=new pt(this._endpoint,{websocket:e}),!this._transport.supported())throw new Error("WebSocket constructor not found, make sure it is available globally or passed as a dependency in Centrifuge options")}const o=this,c=this._transport,u=this._nextTransportId();o._debug("id of transport",u);let l=!1;const f=[];if(this._transport.emulation()){const h=o._sendConnect(!0);f.push(h)}this._setNetworkEvents();const a=this._codec.encodeCommands(f);this._transportClosed=!1;let m;m=setTimeout(function(){c.close()},this._config.timeout),this._transport.initialize(this._codecName(),{onOpen:function(){if(m&&(clearTimeout(m),m=null),o._transportId!=u){o._debug("open callback from non-actual transport"),c.close();return}l=!0,o._debug(c.subName(),"transport open"),!c.emulation()&&(o._transportIsOpen=!0,o._transportWasOpen=!0,o.startBatching(),o._sendConnect(!1),o._sendSubscribeCommands(),o.stopBatching(),o.emit("__centrifuge_debug:connect_frame_sent",{}))},onError:function(h){if(o._transportId!=u){o._debug("error callback from non-actual transport");return}o._debug("transport level error",h)},onClose:function(h){if(m&&(clearTimeout(m),m=null),o._transportId!=u){o._debug("close callback from non-actual transport");return}o._debug(c.subName(),"transport closed"),o._transportClosed=!0,o._transportIsOpen=!1;let _="connection closed",d=!0,p=0;if(h&&"code"in h&&h.code&&(p=h.code),h&&h.reason)try{const b=JSON.parse(h.reason);_=b.reason,d=b.reconnect}catch{_=h.reason,(p>=3500&&p<4e3||p>=4500&&p<5e3)&&(d=!1)}p<3e3?(p===1009?(p=K.messageSizeLimit,_="message size limit exceeded",d=!1):(p=z.transportClosed,_="transport closed"),o._emulation&&!o._transportWasOpen&&(o._currentTransportIndex++,o._currentTransportIndex>=o._transports.length&&(o._triedAllTransports=!0,o._currentTransportIndex=0))):o._transportWasOpen=!0,o._isConnecting()&&!l&&o.emit("error",{type:"transport",error:{code:w.transportClosed,message:"transport closed"},transport:c.name()}),o._reconnecting=!1,o._disconnect(p,_,d)},onMessage:function(h){o._dataReceived(h)}},a),o.emit("__centrifuge_debug:transport_initialized",{})}_sendConnect(e){const n=this._constructConnectCommand(),s=this;return this._call(n,e).then(r=>{const i=r.reply.connect;s._connectResponse(i),r.next&&r.next()},r=>{s._connectError(r.error),r.next&&r.next()}),n}_startReconnecting(){if(this._debug("start reconnecting"),!this._isConnecting()){this._debug("stop reconnecting: client not in connecting state");return}if(this._reconnecting){this._debug("reconnect already in progress, return from reconnect routine");return}if(this._transportClosed===!1){this._debug("waiting for transport close");return}this._reconnecting=!0;const e=this._token==="";if(!(this._refreshRequired||e&&this._config.getToken!==null)){this._config.getData?this._config.getData().then(r=>{this._isConnecting()&&(this._data=r,this._initializeTransport())}).catch(r=>this._handleGetDataError(r)):this._initializeTransport();return}const s=this;this._getToken().then(function(r){if(s._isConnecting()){if(r==null||r==null){s._failUnauthorized();return}s._token=r,s._debug("connection token refreshed"),s._config.getData?s._config.getData().then(function(i){s._isConnecting()&&(s._data=i,s._initializeTransport())}).catch(i=>s._handleGetDataError(i)):s._initializeTransport()}}).catch(function(r){if(!s._isConnecting())return;if(r instanceof N){s._failUnauthorized();return}s.emit("error",{type:"connectToken",error:{code:w.clientConnectToken,message:r!==void 0?r.toString():""}});const i=s._getReconnectDelay();s._debug("error on getting connection token, reconnect after "+i+" milliseconds",r),s._reconnecting=!1,s._reconnectTimeout=setTimeout(()=>{s._startReconnecting()},i)})}_handleGetDataError(e){if(e instanceof N){this._failUnauthorized();return}this.emit("error",{type:"connectData",error:{code:w.badConfiguration,message:e?.toString()||""}});const n=this._getReconnectDelay();this._debug("error on getting connect data, reconnect after "+n+" milliseconds",e),this._reconnecting=!1,this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},n)}_connectError(e){this.state===E.Connecting&&(e.code===109&&(this._refreshRequired=!0),e.code<100||e.temporary===!0||e.code===109?(this.emit("error",{type:"connect",error:e}),this._debug("closing transport due to connect error"),this._disconnect(e.code,e.message,!0)):this._disconnect(e.code,e.message,!1))}_scheduleReconnect(){if(!this._isConnecting())return;let e=!1;this._emulation&&!this._transportWasOpen&&!this._triedAllTransports&&(e=!0);let n=this._getReconnectDelay();e&&(n=0),this._debug("reconnect after "+n+" milliseconds"),this._clearReconnectTimeout(),this._reconnectTimeout=setTimeout(()=>{this._startReconnecting()},n)}_constructConnectCommand(){const e={};this._token&&(e.token=this._token),this._data&&(e.data=this._data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version),Object.keys(this._config.headers).length>0&&(e.headers=this._config.headers);const n={};let s=!1;for(const r in this._serverSubs)if(this._serverSubs.hasOwnProperty(r)&&this._serverSubs[r].recoverable){s=!0;const i={recover:!0};this._serverSubs[r].offset&&(i.offset=this._serverSubs[r].offset),this._serverSubs[r].epoch&&(i.epoch=this._serverSubs[r].epoch),n[r]=i}return s&&(e.subs=n),{connect:e}}_getHistoryRequest(e,n){const s={channel:e};return n!==void 0&&(n.since&&(s.since={offset:n.since.offset},n.since.epoch&&(s.since.epoch=n.since.epoch)),n.limit!==void 0&&(s.limit=n.limit),n.reverse===!0&&(s.reverse=!0)),s}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,n)=>{const s=setTimeout(function(){n({code:w.timeout,message:"timeout"})},this._config.timeout);this._promises[this._nextPromiseId()]={timeout:s,resolve:e,reject:n}})}_callPromise(e,n){return new Promise((s,r)=>{this._call(e,!1).then(i=>{var o;const c=n(i.reply);s(c),(o=i.next)===null||o===void 0||o.call(i)},i=>{var o;r(i.error),(o=i.next)===null||o===void 0||o.call(i)})})}_dataReceived(e){this._serverPing>0&&this._waitServerPing();const n=this._codec.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let s;this._dispatchPromise=new Promise(r=>{s=r}),this._dispatchSynchronized(n,s)})}_dispatchSynchronized(e,n){let s=Promise.resolve();for(const r in e)e.hasOwnProperty(r)&&(s=s.then(()=>this._dispatchReply(e[r])));s=s.then(()=>{n()})}_dispatchReply(e){let n;const s=new Promise(i=>{n=i});if(e==null)return this._debug("dispatch: got undefined or null reply"),n(),s;const r=e.id;return r&&r>0?this._handleReply(e,n):e.push?this._handlePush(e.push,n):this._handleServerPing(n),s}_call(e,n){return new Promise((s,r)=>{e.id=this._nextCommandId(),this._registerCall(e.id,s,r),n||this._addCommand(e)})}_startConnecting(){this._debug("start connecting"),this._setState(E.Connecting)&&this.emit("connecting",{code:z.connectCalled,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(e,n,s){if(this._isDisconnected())return;this._transportIsOpen=!1;const r=this.state;this._reconnecting=!1;const i={code:e,reason:n};let o=!1;if(s?o=this._setState(E.Connecting):(o=this._setState(E.Disconnected),this._rejectPromises({code:w.clientDisconnected,message:"disconnected"})),this._clearOutgoingRequests(),r===E.Connecting&&this._clearReconnectTimeout(),r===E.Connected&&this._clearConnectedState(),o&&(this._isConnecting()?this.emit("connecting",i):this.emit("disconnected",i)),this._transport){this._debug("closing existing transport");const c=this._transport;this._transport=null,c.close(),this._transportClosed=!0,this._nextTransportId()}else this._debug("no transport to close");this._scheduleReconnect()}_failUnauthorized(){this._disconnect(K.unauthorized,"unauthorized",!1)}_getToken(){return this._debug("get connection token"),this._config.getToken?this._config.getToken({}):(this.emit("error",{type:"configuration",error:{code:w.badConfiguration,message:"token expired but no getToken function set in the configuration"}}),Promise.reject(new N("")))}_refresh(){const e=this._client,n=this;this._getToken().then(function(s){if(e!==n._client)return;if(!s){n._failUnauthorized();return}if(n._token=s,n._debug("connection token refreshed"),!n._isConnected())return;const r={refresh:{token:n._token}};n._call(r,!1).then(i=>{const o=i.reply.refresh;n._refreshResponse(o),i.next&&i.next()},i=>{n._refreshError(i.error),i.next&&i.next()})}).catch(function(s){if(n._isConnected()){if(s instanceof N){n._failUnauthorized();return}n.emit("error",{type:"refreshToken",error:{code:w.clientRefreshToken,message:s!==void 0?s.toString():""}}),n._refreshTimeout=setTimeout(()=>n._refresh(),n._getRefreshRetryDelay())}})}_refreshError(e){e.code<100||e.temporary===!0?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return me(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),be(e.ttl)))}_removeSubscription(e){e!==null&&delete this._subs[e.channel]}_unsubscribe(e){if(!this._transportIsOpen)return Promise.resolve();const s={unsubscribe:{channel:e.channel}},r=this;return new Promise((o,c)=>{this._call(s,!1).then(u=>{o(),u.next&&u.next()},u=>{o(),u.next&&u.next(),r._disconnect(z.unsubscribeError,"unsubscribe error",!0)})})}_getSub(e){const n=this._subs[e];return n||null}_isServerSub(e){return this._serverSubs[e]!==void 0}_sendSubscribeCommands(){const e=[];for(const n in this._subs){if(!this._subs.hasOwnProperty(n))continue;const s=this._subs[n];if(s._inflight!==!0&&s.state===P.Subscribing){const r=s._subscribe();r&&e.push(r)}}return e}_connectResponse(e){if(this._transportIsOpen=!0,this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,this._isConnected())return;this._client=e.client,this._setState(E.Connected),this._refreshTimeout&&clearTimeout(this._refreshTimeout),e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),be(e.ttl))),this._session=e.session,this._node=e.node,this.startBatching(),this._sendSubscribeCommands(),this.stopBatching();const n={client:e.client,transport:this._transport.subName()};e.data&&(n.data=e.data),this.emit("connected",n),this._resolvePromises(),this._processServerSubs(e.subs||{}),e.ping&&e.ping>0?(this._serverPing=e.ping*1e3,this._sendPong=e.pong===!0,this._waitServerPing()):this._serverPing=0}_processServerSubs(e){for(const n in e){if(!e.hasOwnProperty(n))continue;const s=e[n];this._serverSubs[n]={offset:s.offset,epoch:s.epoch,recoverable:s.recoverable||!1};const r=this._getSubscribeContext(n,s);this.emit("subscribed",r)}for(const n in e){if(!e.hasOwnProperty(n))continue;const s=e[n];if(s.recovered){const r=s.publications;if(r&&r.length>0)for(const i in r)r.hasOwnProperty(i)&&this._handlePublication(n,r[i])}}for(const n in this._serverSubs)this._serverSubs.hasOwnProperty(n)&&(e[n]||(this.emit("unsubscribed",{channel:n}),delete this._serverSubs[n]))}_clearRefreshTimeout(){this._refreshTimeout!==null&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){this._reconnectTimeout!==null&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){this._serverPingTimeout!==null&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){this._config.maxServerPingDelay!==0&&this._isConnected()&&(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{this._isConnected()&&this._disconnect(z.noPing,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay))}_getSubscribeContext(e,n){const s={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1,hasRecoveredPublications:!1};n.recovered&&(s.recovered=!0),n.positioned&&(s.positioned=!0),n.recoverable&&(s.recoverable=!0),n.was_recovering&&(s.wasRecovering=!0);let r="";"epoch"in n&&(r=n.epoch);let i=0;return"offset"in n&&(i=n.offset),(s.positioned||s.recoverable)&&(s.streamPosition={offset:i,epoch:r}),Array.isArray(n.publications)&&n.publications.length>0&&(s.hasRecoveredPublications=!0),n.data&&(s.data=n.data),s}_handleReply(e,n){const s=e.id;if(!(s in this._callbacks)){n();return}const r=this._callbacks[s];if(clearTimeout(this._callbacks[s].timeout),delete this._callbacks[s],gs(e)){const i=r.errback;if(!i){n();return}const o={code:e.error.code,message:e.error.message||"",temporary:e.error.temporary||!1};i({error:o,next:n})}else{const i=r.callback;if(!i)return;i({reply:e,next:n})}}_handleJoin(e,n){const s=this._getSub(e);if(!s){if(this._isServerSub(e)){const r={channel:e,info:this._getJoinLeaveContext(n.info)};this.emit("join",r)}return}s._handleJoin(n)}_handleLeave(e,n){const s=this._getSub(e);if(!s){if(this._isServerSub(e)){const r={channel:e,info:this._getJoinLeaveContext(n.info)};this.emit("leave",r)}return}s._handleLeave(n)}_handleUnsubscribe(e,n){const s=this._getSub(e);if(!s){this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}));return}n.code<2500?s._setUnsubscribed(n.code,n.reason,!1):s._setSubscribing(n.code,n.reason)}_handleSubscribe(e,n){this._serverSubs[e]={offset:n.offset,epoch:n.epoch,recoverable:n.recoverable||!1},this.emit("subscribed",this._getSubscribeContext(e,n))}_handleDisconnect(e){const n=e.code;let s=!0;(n>=3500&&n<4e3||n>=4500&&n<5e3)&&(s=!1),this._disconnect(n,e.reason,s)}_getPublicationContext(e,n){const s={channel:e,data:n.data};return n.offset&&(s.offset=n.offset),n.info&&(s.info=this._getJoinLeaveContext(n.info)),n.tags&&(s.tags=n.tags),s}_getJoinLeaveContext(e){const n={client:e.client,user:e.user},s=e.conn_info;s&&(n.connInfo=s);const r=e.chan_info;return r&&(n.chanInfo=r),n}_handlePublication(e,n){const s=this._getSub(e);if(!s){if(this._isServerSub(e)){const r=this._getPublicationContext(e,n);this.emit("publication",r),n.offset!==void 0&&(this._serverSubs[e].offset=n.offset)}return}s._handlePublication(n)}_handleMessage(e){this.emit("message",{data:e.data})}_handleServerPing(e){if(this._sendPong){const n={};this._transportSendCommands([n])}e()}_handlePush(e,n){const s=e.channel;e.pub?this._handlePublication(s,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(s,e.join):e.leave?this._handleLeave(s,e.leave):e.unsubscribe?this._handleUnsubscribe(s,e.unsubscribe):e.subscribe?this._handleSubscribe(s,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),n()}_flush(){const e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,n,s){const r={code:e,message:n};return s&&(r.temporary=!0),r}_registerCall(e,n,s){this._callbacks[e]={callback:n,errback:s,timeout:null},this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],hn(s)&&s({error:this._createErrorObject(w.timeout,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_nextTransportId(){return++this._transportId}_resolvePromises(){for(const e in this._promises)this._promises.hasOwnProperty(e)&&(this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e])}_rejectPromises(e){for(const n in this._promises)this._promises.hasOwnProperty(n)&&(this._promises[n].timeout&&clearTimeout(this._promises[n].timeout),this._promises[n].reject(e),delete this._promises[n])}}we.SubscriptionState=P;we.State=E;we.UnauthorizedError=N;function Is(t,e){const n=T.socket=new we(t);n.setToken(e),n.on("connected",s=>{T.connected=!0,T.taskQueue.forEach(r=>r()),T.taskQueue=[],T.socketId=s.client}),n.on("disconnected",s=>{T.connected=!1}),n.on("error",s=>{T.connected=!1}),n.connect()}function fn(t,e){return t.key+"_"+e.eventName}function xs(t,e){const n=T.listeners.get(t.key);if(!n)return;const s=e.data,r=n.get(fn(t,s));r&&r.forEach(i=>{try{i(e.data.payload)}catch{console.error("handleIncomingMessage",t,e)}})}function qe(t){return new Promise((e,n)=>{let s=T.socket.getSubscription(t.key);s?.state===P.Subscribed&&e({subscription:s});const r=()=>{s=T.socket.getSubscription(t.key),s?.state!==P.Subscribed&&(s?(s.subscribe(),e({subscription:s})):(s=T.socket.newSubscription(t.key),os("%c subscribed on "+t.key,"color: #0f0"),s.on("publication",i=>{xs(t,i)}),s.on("subscribed",()=>{e({subscription:s})}),s.subscribe()))};T.connected?r():T.taskQueue.push(r)})}function Ds(t){return T.listeners.get(t.key)||T.emitters.get(t.key)}function Ls(t){if(Ds(t))return;const n=T.socket.getSubscription(t.key);n&&n.unsubscribe()}function Us(){return Math.random().toString(36).substring(2)}function As(t,e,n){qe(t),T.listeners.has(t.key)||T.listeners.set(t.key,new Map);const s=T.listeners.get(t.key),r=fn(t,e);s.has(r)||s.set(r,new Map);const i=s.get(r),o=r+"--"+Us();return i.set(o,n),()=>{i.delete(o),i.size===0&&s.delete(r),s.size===0&&T.listeners.delete(t.key),Ls(t)}}function Ns(t,e){return typeof t.transform=="function"?t.transform(t.eventName,e):{eventName:t.eventName,payload:e}}async function js(t,e,n){try{const s=(await qe(t)).subscription,r=Ns(e,n);await s.publish(r)}catch(s){console.error(t,e,n,s)}}let W={NEGOTIATE:new ue,ICE_CANDIDATE:new ue,OFFER:new ue,ANSWER:new ue};is(W);function Ms(t,e){return bt(t)<bt(e)}function bt(t){let e,n=new Uint32Array([1,2,3,4].map(s=>parseInt(t.substr(s*8,8),16)));return e=n[3],n[3]=n[2],n[2]=n[1],n[1]=n[0],e^=e<<11,e^=e>>>8,n[0]=e^n[0]^n[0]>>>19,n[0]/4294967296}var I=(t=>(t.HIGH="HIGH",t.MEDIUM="MEDIUM",t.LOW="LOW",t))(I||{});I.HIGH+"",I.MEDIUM+"",I.LOW+"";I.HIGH+"",I.MEDIUM+"",I.LOW+"";const gt=t=>!0,vt=t=>!0;I.HIGH+"",I.MEDIUM+"",I.LOW+"";I.HIGH+"",I.MEDIUM+"",I.LOW+"";const yt=t=>!0,Le=tn((t,e)=>{async function n(r,i){r&&await r.applyConstraints(i)}function s(...r){const i={};r.forEach(o=>{const c=e()[o];c&&(c.stop(),i[o]=null)}),t(i)}return{quality:I.LOW,async setQuality(r){const{cameraStreamTrack:i,desktopStreamTrack:o,microphoneStreamTrack:c}=e();await n(i,yt()),await n(o,gt()),await n(c,vt()),t({quality:r})},async startCameraStream(){const i=(await navigator.mediaDevices.getUserMedia({audio:!1,video:yt(e().quality)})).getTracks()[0];t({cameraStreamTrack:i})},async stopCameraStream(){s("cameraStreamTrack")},async startDesktopStream(){const i=(await navigator.mediaDevices.getDisplayMedia({audio:!1,video:gt(e().quality)})).getTracks()[0];t({desktopStreamTrack:i})},async stopDesktopStream(){s("desktopStreamTrack")},async startMicrophoneStream(){const i=(await navigator.mediaDevices.getUserMedia({video:!1,audio:vt(e().quality)})).getTracks()[0];t({microphoneStreamTrack:i})},async stopMicrophoneStream(){s("microphoneStreamTrack")},stop(){s("cameraStreamTrack","desktopStreamTrack","microphoneStreamTrack")},getActualTracks(r){const i=[],{desktopStreamTrack:o,cameraStreamTrack:c,microphoneStreamTrack:u}=e();return o?i.push(o):c&&i.push(c),!r&&u&&i.push(u),i}}}),dn=tn((t,e)=>{function n(_,d){As(Ee(e().conferenceId),_,p=>p.to===e().currentUserId&&d(p))}async function s(_,d){await js(Ee(e().conferenceId),_,d)}async function r(_){const d=e().otherUsers.filter(p=>!_.includes(p.userId));d.length&&(D("[AppStore] handleLeft, leftUsers:",d),d.forEach(p=>p.connection.disconnect()),t({otherUsers:e().otherUsers.filter(p=>!d.includes(p))}))}async function i(_){const d=await _.connection.createOffer();D("send offer to:",_.userId),await s(W.OFFER,l(_,d))}async function o(_){const{otherUsers:d,currentUserId:p}=e(),b=d.map(C=>C.userId),v=_.filter(C=>!b.includes(C));if(!v.length)return;D("[AppStore] handleJoined, joinedUsers:",v);const x=v.map(C=>({userId:C,tracks:[]}));t({otherUsers:[...d,...x]}),x.map(async C=>{Ms(e().currentUserId,C.userId)&&(await a(C),await i(C))})}async function c(_){const d=await _.presence(),p=e().currentUserId,b=Object.values(d.clients).map(v=>v.client).filter(v=>v!==p);await r(b),await o(b)}function u(_){return d=>{_(e().otherUsers.find(p=>p.userId===d.from),d.payload)}}function l(_,d){return{from:e().currentUserId,to:_.userId,payload:d}}async function f(_,d){D("processOffer from:",_.userId),await a(_);const p=await _.connection.receiveOffer(d);D("sendAnswer to:",_.userId),await s(W.ANSWER,l(_,p))}async function a(_,d){if(_.connection)return;D(`createConnection 
src:`,e().currentUserId,`
dst:`,_.userId),_.connection=rs(e().currentUserId,_.userId);const p=_.connection.state.peerConnection;p.onicecandidate=async b=>{await s(W.ICE_CANDIDATE,l(_,b.candidate))},p.onnegotiationneeded=async b=>{D("negotiation needed with:",_.userId),await i(_)},p.onconnectionstatechange=b=>{D("connection state with:",_.userId,`
`,p.connectionState),document.title=p.connectionState},p.ontrack=b=>{D("tracks changed:",_.userId,b),_.tracks.push(b.track),t({otherUsers:e().otherUsers})},await _.connection.updateTracks(Le.getState().getActualTracks())}async function m(_,d){D("processAnswer from:",_.userId),await _.connection.receiveAnswer(d)}async function h(_,d){_.connection.iceCandidate(d)}return{otherUsers:[],async updateTracks(){const _=Le.getState().getActualTracks();e().otherUsers.forEach(d=>d.connection.updateTracks(_)),console.log("updateTracks:",_)},async enter(_,d){t({currentUserId:_,conferenceId:d});const p=Ee(d),{subscription:b}=await qe(p);await c(b),b.on("leave",async()=>await c(b)),b.on("join",async()=>await c(b)),n(W.OFFER,u(f)),n(W.ANSWER,u(m)),n(W.ICE_CANDIDATE,u(h)),n(W.NEGOTIATE,u(v=>{D("received NEGOTIATE from:",v.userId),i(v)}))}}});function Ee(t){return{key:"conf"+t}}function $s(){const{updateTracks:t,otherUsers:e}=dn(),n=Le();async function s(){await(n.cameraStreamTrack?n.stopCameraStream:n.startCameraStream)(),await t()}async function r(){await(n.microphoneStreamTrack?n.stopMicrophoneStream:n.startMicrophoneStream)(),await t()}async function i(){await(n.desktopStreamTrack?n.stopDesktopStream:n.startDesktopStream)(),await t()}return R("div",{children:[R("button",{onClick:s,children:n.cameraStreamTrack?"disable cam":"enable cam"}),R("button",{onClick:r,children:n.microphoneStreamTrack?"disable mic":"enable mic"}),R("button",{onClick:i,children:(n.desktopStreamTrack,"share screen")}),R("div",{children:[R(wt,{tracks:n.getActualTracks(!1)}),e.map(o=>R(wt,{tracks:o.tracks},o.userId))]})]})}function wt({tracks:t}){return R("div",{style:{border:"1px solid black",width:300,minHeight:200},children:[R("div",{children:["tracks: ",t.length]}),t.map(e=>R(Ws,{track:e},e.id))]})}function Ws({track:t}){return t.kind==="audio"?R(zs,{track:t}):R(Hs,{track:t})}function zs({track:t}){return R("audio",{autoplay:!0,playsInline:!0,srcObject:new MediaStream([t])})}function Hs({track:t}){return R("video",{width:300,muted:!0,autoPlay:!0,playsinline:!0,playsInline:!0,srcObject:new MediaStream([t])})}async function Fs(t,e,n,s){return new Promise((r,i)=>{t.open("POST",e),t.onload=()=>r(JSON.parse(t.response||t.responseText)),t.onerror=i,t.send(JSON.stringify({user_id:n,name:s}))})}function qs(t){return{render:function(e){Kt(e,t)},unmount:function(){en(t)}}}const Bs=document.getElementById("root");qs(Bs).render(R($s,{}));(async function(){const t="https://chessclub.spb.ru/rest/auth.rest.jwt",e=new XMLHttpRequest,{session:n}=await Fs(e,t,"userId","test-client");Is("wss://chessclub.spb.ru/centrifugo/connection/websocket",n),T.socket.on("connected",()=>{const r=T.socketId;dn.getState().enter(r,"deadbeef")})})();
